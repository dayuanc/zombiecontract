å¤§çˆ±loomï¼å¤§çˆ±loomï¼

# å››ã€åƒµå°¸è¦å¼€æˆ˜äº†ï¼

## ç¬¬1ç« : å¯æ”¯ä»˜

æˆªè‡³ç›®å‰ï¼Œæˆ‘ä»¬åªæ¥è§¦åˆ°å¾ˆå°‘çš„ **å‡½æ•°ä¿®é¥°ç¬¦**ã€‚ è¦è®°ä½æ‰€æœ‰çš„ä¸œè¥¿å¾ˆéš¾ï¼Œæ‰€ä»¥æˆ‘ä»¬æ¥ä¸ªæ¦‚è§ˆï¼š

1. æˆ‘ä»¬æœ‰å†³å®šå‡½æ•°ä½•æ—¶å’Œè¢«è°è°ƒç”¨çš„å¯è§æ€§ä¿®é¥°ç¬¦: `private` æ„å‘³ç€å®ƒåªèƒ½è¢«åˆçº¦å†…éƒ¨è°ƒç”¨ï¼› `internal` å°±åƒ `private` ä½†æ˜¯ä¹Ÿèƒ½è¢«ç»§æ‰¿çš„åˆçº¦è°ƒç”¨ï¼› `external` åªèƒ½ä»åˆçº¦å¤–éƒ¨è°ƒç”¨ï¼›æœ€å `public` å¯ä»¥åœ¨ä»»ä½•åœ°æ–¹è°ƒç”¨ï¼Œä¸ç®¡æ˜¯å†…éƒ¨è¿˜æ˜¯å¤–éƒ¨ã€‚
2. æˆ‘ä»¬ä¹Ÿæœ‰çŠ¶æ€ä¿®é¥°ç¬¦ï¼Œ å‘Šè¯‰æˆ‘ä»¬å‡½æ•°å¦‚ä½•å’ŒåŒºå—é“¾äº¤äº’: `view` å‘Šè¯‰æˆ‘ä»¬è¿è¡Œè¿™ä¸ªå‡½æ•°ä¸ä¼šæ›´æ”¹å’Œä¿å­˜ä»»ä½•æ•°æ®ï¼› `pure` å‘Šè¯‰æˆ‘ä»¬è¿™ä¸ªå‡½æ•°ä¸ä½†ä¸ä¼šå¾€åŒºå—é“¾å†™æ•°æ®ï¼Œå®ƒç”šè‡³ä¸ä»åŒºå—é“¾è¯»å–æ•°æ®ã€‚è¿™ä¸¤ç§åœ¨è¢«ä»åˆçº¦å¤–éƒ¨è°ƒç”¨çš„æ—¶å€™éƒ½ä¸èŠ±è´¹ä»»ä½•gasï¼ˆä½†æ˜¯å®ƒä»¬åœ¨è¢«å†…éƒ¨å…¶ä»–å‡½æ•°è°ƒç”¨çš„æ—¶å€™å°†ä¼šè€—è´¹gasï¼‰ã€‚
3. ç„¶åæˆ‘ä»¬æœ‰äº†è‡ªå®šä¹‰çš„ `modifiers`ï¼Œä¾‹å¦‚åœ¨ç¬¬ä¸‰è¯¾å­¦ä¹ çš„: `onlyOwner`å’Œ `aboveLevel`ã€‚ å¯¹äºè¿™äº›ä¿®é¥°ç¬¦æˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰å…¶å¯¹å‡½æ•°çš„çº¦æŸé€»è¾‘ã€‚

è¿™äº›ä¿®é¥°ç¬¦å¯ä»¥åŒæ—¶ä½œç”¨äºä¸€ä¸ªå‡½æ•°å®šä¹‰ä¸Šï¼š

```
function test() external view onlyOwner anotherModifier { /* ... */ }
```

åœ¨è¿™ä¸€ç« ï¼Œæˆ‘ä»¬æ¥å­¦ä¹ ä¸€ä¸ªæ–°çš„ä¿®é¥°ç¬¦ `payable`.

### `payable` ä¿®é¥°ç¬¦

`payable` æ–¹æ³•æ˜¯è®© Solidity å’Œä»¥å¤ªåŠå˜å¾—å¦‚æ­¤é…·çš„ä¸€éƒ¨åˆ† â€”â€” å®ƒä»¬æ˜¯ä¸€ç§å¯ä»¥æ¥æ”¶ä»¥å¤ªçš„ç‰¹æ®Šå‡½æ•°ã€‚

å…ˆæ”¾ä¸€ä¸‹ã€‚å½“ä½ åœ¨è°ƒç”¨ä¸€ä¸ªæ™®é€šç½‘ç«™æœåŠ¡å™¨ä¸Šçš„APIå‡½æ•°çš„æ—¶å€™ï¼Œä½ æ— æ³•ç”¨ä½ çš„å‡½æ•°ä¼ é€ç¾å…ƒâ€”â€”ä½ ä¹Ÿä¸èƒ½ä¼ é€æ¯”ç‰¹å¸ã€‚

ä½†æ˜¯åœ¨ä»¥å¤ªåŠä¸­ï¼Œ å› ä¸ºé’± (*ä»¥å¤ª*), æ•°æ® (*äº‹åŠ¡è´Ÿè½½*)ï¼Œ ä»¥åŠåˆçº¦ä»£ç æœ¬èº«éƒ½å­˜åœ¨äºä»¥å¤ªåŠã€‚ä½ å¯ä»¥åœ¨åŒæ—¶è°ƒç”¨å‡½æ•° **å¹¶**ä»˜é’±ç»™å¦å¤–ä¸€ä¸ªåˆçº¦ã€‚

è¿™å°±å…è®¸å‡ºç°å¾ˆå¤šæœ‰è¶£çš„é€»è¾‘ï¼Œ æ¯”å¦‚å‘ä¸€ä¸ªåˆçº¦è¦æ±‚æ”¯ä»˜ä¸€å®šçš„é’±æ¥è¿è¡Œä¸€ä¸ªå‡½æ•°ã€‚

### æ¥çœ‹ä¸ªä¾‹å­

```
contract OnlineStore {
  function buySomething() external payable {
    // æ£€æŸ¥ä»¥ç¡®å®š0.001ä»¥å¤ªå‘é€å‡ºå»æ¥è¿è¡Œå‡½æ•°:
    require(msg.value == 0.001 ether);
    // å¦‚æœä¸ºçœŸï¼Œä¸€äº›ç”¨æ¥å‘å‡½æ•°è°ƒç”¨è€…å‘é€æ•°å­—å†…å®¹çš„é€»è¾‘
    transferThing(msg.sender);
  }
}
```

åœ¨è¿™é‡Œï¼Œ**`msg.value` æ˜¯ä¸€ç§å¯ä»¥æŸ¥çœ‹å‘åˆçº¦å‘é€äº†å¤šå°‘ä»¥å¤ªçš„æ–¹æ³•**ï¼Œå¦å¤– `ether` æ˜¯ä¸€ä¸ªå…§å»ºå•å…ƒã€‚

è¿™é‡Œå‘ç”Ÿçš„äº‹æ˜¯ï¼Œä¸€äº›äººä¼šä» web3.js è°ƒç”¨è¿™ä¸ªå‡½æ•° (ä»DAppçš„å‰ç«¯)ï¼Œ åƒè¿™æ · :

```
// å‡è®¾ `OnlineStore` åœ¨ä»¥å¤ªåŠä¸ŠæŒ‡å‘ä½ çš„åˆçº¦:
OnlineStore.buySomething().send(from: web3.eth.defaultAccount, value: web3.utils.toWei(0.001))
```

æ³¨æ„è¿™ä¸ª `value` å­—æ®µï¼Œ JavaScript è°ƒç”¨æ¥æŒ‡å®šå‘é€å¤šå°‘(0.001)`ä»¥å¤ª`ã€‚å¦‚æœæŠŠäº‹åŠ¡æƒ³è±¡æˆä¸€ä¸ªä¿¡å°ï¼Œä½ å‘é€åˆ°å‡½æ•°çš„å‚æ•°å°±æ˜¯ä¿¡çš„å†…å®¹ã€‚ æ·»åŠ ä¸€ä¸ª `value` å¾ˆåƒåœ¨ä¿¡å°é‡Œé¢æ”¾é’± â€”â€” ä¿¡ä»¶å†…å®¹å’Œé’±åŒæ—¶å‘é€ç»™äº†æ¥æ”¶è€…ã€‚

> æ³¨æ„ï¼š å¦‚æœä¸€ä¸ªå‡½æ•°æ²¡æ ‡è®°ä¸º`payable`ï¼Œ è€Œä½ å°è¯•åˆ©ç”¨ä¸Šé¢çš„æ–¹æ³•å‘é€ä»¥å¤ªï¼Œå‡½æ•°å°†æ‹’ç»ä½ çš„äº‹åŠ¡ã€‚

### å®æˆ˜æ¼”ä¹ 

æˆ‘ä»¬æ¥åœ¨åƒµå°¸æ¸¸æˆé‡Œé¢åˆ›å»ºä¸€ä¸ª`payable` å‡½æ•°ã€‚

å‡å®šåœ¨æˆ‘ä»¬çš„æ¸¸æˆä¸­ï¼Œç©å®¶å¯ä»¥é€šè¿‡æ”¯ä»˜ETHæ¥å‡çº§ä»–ä»¬çš„åƒµå°¸ã€‚ETHå°†å­˜å‚¨åœ¨ä½ æ‹¥æœ‰çš„åˆçº¦ä¸­ â€”â€” ä¸€ä¸ªç®€å•æ˜äº†çš„ä¾‹å­ï¼Œå‘ä½ å±•ç¤ºä½ å¯ä»¥é€šè¿‡è‡ªå·±çš„æ¸¸æˆèµšé’±ã€‚

1. å®šä¹‰ä¸€ä¸ª `uint` ï¼Œå‘½åä¸º `levelUpFee`, å°†å€¼è®¾å®šä¸º `0.001 ether`ã€‚
2. å®šä¹‰ä¸€ä¸ªåä¸º `levelUp` çš„å‡½æ•°ã€‚ å®ƒå°†æ¥æ”¶ä¸€ä¸ª `uint` å‚æ•° `_zombieId`ã€‚ å‡½æ•°åº”è¯¥ä¿®é¥°ä¸º `external` ä»¥åŠ `payable`ã€‚
3. è¿™ä¸ªå‡½æ•°é¦–å…ˆåº”è¯¥ `require` ç¡®ä¿ `msg.value` ç­‰äº `levelUpFee`ã€‚
4. ç„¶åå®ƒåº”è¯¥å¢åŠ åƒµå°¸çš„ `level`: `zombies[_zombieId].level++`ã€‚

```solidity
pragma solidity ^0.4.19;

import "./zombiefeeding.sol";

contract ZombieHelper is ZombieFeeding {

  // 1. åœ¨è¿™é‡Œå®šä¹‰ levelUpFee
  uint levelUpFee = 0.001 ether;

  modifier aboveLevel(uint _level, uint _zombieId) {
    require(zombies[_zombieId].level >= _level);
    _;
  }

  // 2. åœ¨è¿™é‡Œæ’å…¥ levelUp å‡½æ•° 
  function levelup(uint _zombieId) external payable {
    require(msg.value == levelUpFee);
    zombies[_zombieid].level++;
  }

  function changeName(uint _zombieId, string _newName) external aboveLevel(2, _zombieId) {
    require(msg.sender == zombieToOwner[_zombieId]);
    zombies[_zombieId].name = _newName;
  }

  function changeDna(uint _zombieId, uint _newDna) external aboveLevel(20, _zombieId) {
    require(msg.sender == zombieToOwner[_zombieId]);
    zombies[_zombieId].dna = _newDna;
  }

  function getZombiesByOwner(address _owner) external view returns(uint[]) {
    uint[] memory result = new uint[](ownerZombieCount[_owner]);
    uint counter = 0;
    for (uint i = 0; i < zombies.length; i++) {
      if (zombieToOwner[i] == _owner) {
        result[counter] = i;
        counter++;
      }
    }
    return result;
  }

}

```

## ç¬¬2ç« : æç°

åœ¨ä¸Šä¸€ç« ï¼Œæˆ‘ä»¬å­¦ä¹ äº†å¦‚ä½•å‘åˆçº¦å‘é€ä»¥å¤ªï¼Œé‚£ä¹ˆåœ¨å‘é€ä¹‹åä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿ

åœ¨ä½ å‘é€ä»¥å¤ªä¹‹åï¼Œå®ƒå°†è¢«å­˜å‚¨è¿›ä»¥åˆçº¦çš„ä»¥å¤ªåŠè´¦æˆ·ä¸­ï¼Œ å¹¶å†»ç»“åœ¨å“ªé‡Œ â€”â€” é™¤éä½ æ·»åŠ ä¸€ä¸ªå‡½æ•°æ¥ä»åˆçº¦ä¸­æŠŠä»¥å¤ªæç°ã€‚

ä½ å¯ä»¥å†™ä¸€ä¸ªå‡½æ•°æ¥ä»åˆçº¦ä¸­æç°ä»¥å¤ªï¼Œç±»ä¼¼è¿™æ ·ï¼š

```
contract GetPaid is Ownable {
  function withdraw() external onlyOwner {
    owner.transfer(this.balance);
  }
}
```

æ³¨æ„æˆ‘ä»¬ä½¿ç”¨ `Ownable` åˆçº¦ä¸­çš„ `owner` å’Œ `onlyOwner`ï¼Œå‡å®šå®ƒå·²ç»è¢«å¼•å…¥äº†ã€‚

ä½ å¯ä»¥é€šè¿‡ `transfer` å‡½æ•°å‘ä¸€ä¸ªåœ°å€å‘é€ä»¥å¤ªï¼Œ ç„¶å `this.balance` å°†è¿”å›å½“å‰åˆçº¦å­˜å‚¨äº†å¤šå°‘ä»¥å¤ªã€‚ æ‰€ä»¥å¦‚æœ100ä¸ªç”¨æˆ·æ¯äººå‘æˆ‘ä»¬æ”¯ä»˜1ä»¥å¤ªï¼Œ `this.balance` å°†æ˜¯100ä»¥å¤ªã€‚

ä½ å¯ä»¥é€šè¿‡ `transfer` å‘ä»»ä½•ä»¥å¤ªåŠåœ°å€ä»˜é’±ã€‚ æ¯”å¦‚ï¼Œä½ å¯ä»¥æœ‰ä¸€ä¸ªå‡½æ•°åœ¨ `msg.sender` è¶…é¢ä»˜æ¬¾çš„æ—¶å€™ç»™ä»–ä»¬é€€é’±ï¼š

```
uint itemFee = 0.001 ether;
msg.sender.transfer(msg.value - itemFee);
```

æˆ–è€…åœ¨ä¸€ä¸ªæœ‰å–å®¶å’Œå–å®¶çš„åˆçº¦ä¸­ï¼Œ ä½ å¯ä»¥æŠŠå–å®¶çš„åœ°å€å­˜å‚¨èµ·æ¥ï¼Œ å½“æœ‰äººä¹°äº†å®ƒçš„ä¸œè¥¿çš„æ—¶å€™ï¼ŒæŠŠä¹°å®¶æ”¯ä»˜çš„é’±å‘é€ç»™å®ƒ `seller.transfer(msg.value)`ã€‚

æœ‰å¾ˆå¤šä¾‹å­æ¥å±•ç¤ºä»€ä¹ˆè®©ä»¥å¤ªåŠç¼–ç¨‹å¦‚æ­¤ä¹‹é…· â€”â€” ä½ å¯ä»¥æ‹¥æœ‰ä¸€ä¸ªä¸è¢«ä»»ä½•äººæ§åˆ¶çš„å»ä¸­å¿ƒåŒ–å¸‚åœºã€‚

### å®æˆ˜æ¼”ä¹ 

1. åœ¨æˆ‘ä»¬çš„åˆçº¦é‡Œåˆ›å»ºä¸€ä¸ª `withdraw` å‡½æ•°ï¼Œå®ƒåº”è¯¥å‡ ä¹å’Œä¸Šé¢çš„`GetPaid`ä¸€æ ·ã€‚

2. ä»¥å¤ªçš„ä»·æ ¼åœ¨è¿‡å»å‡ å¹´å†…ç¿»äº†åå‡ å€ï¼Œåœ¨æˆ‘ä»¬å†™è¿™ä¸ªæ•™ç¨‹çš„æ—¶å€™ 0.01 ä»¥å¤ªç›¸å½“äº1ç¾å…ƒï¼Œå¦‚æœå®ƒå†ç¿»åå€ 0.001 ä»¥å¤ªå°†æ˜¯10ç¾å…ƒï¼Œé‚£æˆ‘ä»¬çš„æ¸¸æˆå°±å¤ªè´µäº†ã€‚

   æ‰€ä»¥æˆ‘ä»¬åº”è¯¥å†åˆ›å»ºä¸€ä¸ªå‡½æ•°ï¼Œå…è®¸æˆ‘ä»¬ä»¥åˆçº¦æ‹¥æœ‰è€…çš„èº«ä»½æ¥è®¾ç½® `levelUpFee`ã€‚

   a. åˆ›å»ºä¸€ä¸ªå‡½æ•°ï¼Œåä¸º `setLevelUpFee`ï¼Œ å…¶æ¥æ”¶ä¸€ä¸ªå‚æ•° `uint _fee`ï¼Œæ˜¯ `external` å¹¶ä½¿ç”¨ä¿®é¥°ç¬¦ `onlyOwner`ã€‚

   b. è¿™ä¸ªå‡½æ•°åº”è¯¥è®¾ç½® `levelUpFee` ç­‰äº `_fee`ã€‚

```solidity
pragma solidity ^0.4.19;

import "./zombiefeeding.sol";

contract ZombieHelper is ZombieFeeding {

  uint levelUpFee = 0.001 ether;

  modifier aboveLevel(uint _level, uint _zombieId) {
    require(zombies[_zombieId].level >= _level);
    _;
  }

  // 1. åœ¨è¿™é‡Œåˆ›å»º withdraw å‡½æ•°
  function withdraw() external onlyOwner {
 	owner.transfer(this.balance);
  }

  // 2. åœ¨è¿™é‡Œåˆ›å»º setLevelUpFee å‡½æ•° 
  function setLevelUpFee(uint _fee) external onlyOwner {
    this.levelUpFee = _fee;
  } 

  function levelUp(uint _zombieId) external payable {
    require(msg.value == levelUpFee);
    zombies[_zombieId].level++;
  }

  function changeName(uint _zombieId, string _newName) external aboveLevel(2, _zombieId) {
    require(msg.sender == zombieToOwner[_zombieId]);
    zombies[_zombieId].name = _newName;
  }

  function changeDna(uint _zombieId, uint _newDna) external aboveLevel(20, _zombieId) {
    require(msg.sender == zombieToOwner[_zombieId]);
    zombies[_zombieId].dna = _newDna;
  }

  function getZombiesByOwner(address _owner) external view returns(uint[]) {
    uint[] memory result = new uint[](ownerZombieCount[_owner]);
    uint counter = 0;
    for (uint i = 0; i < zombies.length; i++) {
      if (zombieToOwner[i] == _owner) {
        result[counter] = i;
        counter++;
      }
    }
    return result;
  }

}

```

## ç¬¬3ç« : åƒµå°¸æˆ˜æ–—

åœ¨æˆ‘ä»¬å­¦ä¹ äº†å¯æ”¯ä»˜å‡½æ•°å’Œåˆçº¦ä½™é¢ä¹‹åï¼Œæ˜¯æ—¶å€™ä¸ºåƒµå°¸æˆ˜æ–—æ·»åŠ åŠŸèƒ½äº†ã€‚

éµå¾ªä¸Šä¸€ç« çš„æ ¼å¼ï¼Œæˆ‘ä»¬æ–°å»ºä¸€ä¸ªæ”»å‡»åŠŸèƒ½åˆçº¦ï¼Œå¹¶å°†ä»£ç æ”¾è¿›æ–°çš„æ–‡ä»¶ä¸­ï¼Œå¼•å…¥ä¸Šä¸€ä¸ªåˆçº¦ã€‚

### å®æˆ˜æ¼”ä¹ 

å†æ¥æ–°å»ºä¸€ä¸ªåˆçº¦å§ã€‚ç†Ÿèƒ½ç”Ÿå·§ã€‚

å¦‚æœä½ ä¸è®°å¾—æ€ä¹ˆåšäº†, æŸ¥çœ‹ä¸€ä¸‹ `zombiehelper.sol` â€” ä¸è¿‡æœ€å¥½å…ˆè¯•ç€åšä¸€ä¸‹ï¼Œæ£€æŸ¥ä¸€ä¸‹ä½ æŒæ¡çš„æƒ…å†µã€‚

1. åœ¨æ–‡ä»¶å¼€å¤´å®šä¹‰ Solidity çš„ç‰ˆæœ¬ `^0.4.19`.
2. `import` è‡ª `zombiehelper.sol` .
3. å£°æ˜ä¸€ä¸ªæ–°çš„ `contract`ï¼Œå‘½åä¸º `ZombieBattle`ï¼Œ ç»§æ‰¿è‡ª`ZombieHelper`ã€‚å‡½æ•°ä½“å°±å…ˆç©ºç€å§ã€‚

```
pragma solidity ^0.4.19;

import "./zombiehelper.sol";

contract ZombieBattle is ZombieHelper {

}
```

## ç¬¬4ç« : éšæœºæ•°

ä½ å¤ªæ£’äº†ï¼æ¥ä¸‹æ¥æˆ‘ä»¬æ¢³ç†ä¸€ä¸‹æˆ˜æ–—é€»è¾‘ã€‚

ä¼˜ç§€çš„æ¸¸æˆéƒ½éœ€è¦ä¸€äº›éšæœºå…ƒç´ ï¼Œé‚£ä¹ˆæˆ‘ä»¬åœ¨ Solidity é‡Œå¦‚ä½•ç”Ÿæˆéšæœºæ•°å‘¢ï¼Ÿ

çœŸæ­£çš„ç­”æ¡ˆæ˜¯ä½ ä¸èƒ½ï¼Œæˆ–è€…æœ€èµ·ç ï¼Œä½ æ— æ³•å®‰å…¨åœ°åšåˆ°è¿™ä¸€ç‚¹ã€‚

æˆ‘ä»¬æ¥çœ‹çœ‹ä¸ºä»€ä¹ˆ

### ç”¨ `keccak256` æ¥åˆ¶é€ éšæœºæ•°ã€‚

Solidity ä¸­æœ€å¥½çš„éšæœºæ•°ç”Ÿæˆå™¨æ˜¯ `keccak256` å“ˆå¸Œå‡½æ•°.

æˆ‘ä»¬å¯ä»¥è¿™æ ·æ¥ç”Ÿæˆä¸€äº›éšæœºæ•°

```
// ç”Ÿæˆä¸€ä¸ª0åˆ°100çš„éšæœºæ•°:
uint randNonce = 0;
uint random = uint(keccak256(now, msg.sender, randNonce)) % 100;
randNonce++;
uint random2 = uint(keccak256(now, msg.sender, randNonce)) % 100;
```

è¿™ä¸ªæ–¹æ³•é¦–å…ˆæ‹¿åˆ° `now` çš„æ—¶é—´æˆ³ã€ `msg.sender`ã€ ä»¥åŠä¸€ä¸ªè‡ªå¢æ•° `nonce`ï¼ˆä¸€ä¸ªä»…ä¼šè¢«ä½¿ç”¨ä¸€æ¬¡çš„æ•°ï¼Œè¿™æ ·æˆ‘ä»¬å°±ä¸ä¼šå¯¹ç›¸åŒçš„è¾“å…¥å€¼è°ƒç”¨ä¸€æ¬¡ä»¥ä¸Šå“ˆå¸Œå‡½æ•°äº†ï¼‰ã€‚

ç„¶ååˆ©ç”¨ `keccak` æŠŠè¾“å…¥çš„å€¼è½¬å˜ä¸ºä¸€ä¸ªå“ˆå¸Œå€¼, å†å°†å“ˆå¸Œå€¼è½¬æ¢ä¸º `uint`, ç„¶ååˆ©ç”¨ `% 100` æ¥å–æœ€åä¸¤ä½, å°±ç”Ÿæˆäº†ä¸€ä¸ª0åˆ°100ä¹‹é—´éšæœºæ•°äº†ã€‚

### è¿™ä¸ªæ–¹æ³•å¾ˆå®¹æ˜“è¢«ä¸è¯šå®çš„èŠ‚ç‚¹æ”»å‡»

åœ¨ä»¥å¤ªåŠä¸Š, å½“ä½ åœ¨å’Œä¸€ä¸ªåˆçº¦ä¸Šè°ƒç”¨å‡½æ•°çš„æ—¶å€™, ä½ ä¼šæŠŠå®ƒå¹¿æ’­ç»™ä¸€ä¸ªèŠ‚ç‚¹æˆ–è€…åœ¨ç½‘ç»œä¸Šçš„ **transaction** èŠ‚ç‚¹ä»¬ã€‚ ç½‘ç»œä¸Šçš„èŠ‚ç‚¹å°†æ”¶é›†å¾ˆå¤šäº‹åŠ¡, è¯•ç€æˆä¸ºç¬¬ä¸€ä¸ªè§£å†³è®¡ç®—å¯†é›†å‹æ•°å­¦é—®é¢˜çš„äººï¼Œä½œä¸ºâ€œå·¥ä½œè¯æ˜â€ï¼Œç„¶åå°†â€œå·¥ä½œè¯æ˜â€(Proof of Work, PoW)å’Œäº‹åŠ¡ä¸€èµ·ä½œä¸ºä¸€ä¸ª **block** å‘å¸ƒåœ¨ç½‘ç»œä¸Šã€‚

ä¸€æ—¦ä¸€ä¸ªèŠ‚ç‚¹è§£å†³äº†ä¸€ä¸ªPoW, å…¶ä»–èŠ‚ç‚¹å°±ä¼šåœæ­¢å°è¯•è§£å†³è¿™ä¸ª PoW, å¹¶éªŒè¯å…¶ä»–èŠ‚ç‚¹çš„äº‹åŠ¡åˆ—è¡¨æ˜¯æœ‰æ•ˆçš„ï¼Œç„¶åæ¥å—è¿™ä¸ªèŠ‚ç‚¹è½¬è€Œå°è¯•è§£å†³ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚

**è¿™å°±è®©æˆ‘ä»¬çš„éšæœºæ•°å‡½æ•°å˜å¾—å¯åˆ©ç”¨äº†**

æˆ‘ä»¬å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªç¡¬å¸ç¿»è½¬åˆçº¦â€”â€”æ­£é¢ä½ èµ¢åŒå€é’±ï¼Œåé¢ä½ è¾“æ‰æ‰€æœ‰çš„é’±ã€‚å‡å¦‚å®ƒä½¿ç”¨ä¸Šé¢çš„æ–¹æ³•æ¥å†³å®šæ˜¯æ­£é¢è¿˜æ˜¯åé¢ (`random >= 50` ç®—æ­£é¢, `random < 50` ç®—åé¢)ã€‚

å¦‚æœæˆ‘æ­£è¿è¡Œä¸€ä¸ªèŠ‚ç‚¹ï¼Œæˆ‘å¯ä»¥ **åªå¯¹æˆ‘è‡ªå·±çš„èŠ‚ç‚¹** å‘å¸ƒä¸€ä¸ªäº‹åŠ¡ï¼Œä¸”ä¸åˆ†äº«å®ƒã€‚ æˆ‘å¯ä»¥è¿è¡Œç¡¬å¸ç¿»è½¬æ–¹æ³•æ¥å·çª¥æˆ‘çš„è¾“èµ¢ â€” å¦‚æœæˆ‘è¾“äº†ï¼Œæˆ‘å°±ä¸æŠŠè¿™ä¸ªäº‹åŠ¡åŒ…å«è¿›æˆ‘è¦è§£å†³çš„ä¸‹ä¸€ä¸ªåŒºå—ä¸­å»ã€‚æˆ‘å¯ä»¥ä¸€ç›´è¿è¡Œè¿™ä¸ªæ–¹æ³•ï¼Œç›´åˆ°æˆ‘èµ¢å¾—äº†ç¡¬å¸ç¿»è½¬å¹¶è§£å†³äº†ä¸‹ä¸€ä¸ªåŒºå—ï¼Œç„¶åè·åˆ©ã€‚

### æ‰€ä»¥æˆ‘ä»¬è¯¥å¦‚ä½•åœ¨ä»¥å¤ªåŠä¸Šå®‰å…¨åœ°ç”Ÿæˆéšæœºæ•°å‘¢

å› ä¸ºåŒºå—é“¾çš„å…¨éƒ¨å†…å®¹å¯¹æ‰€æœ‰å‚ä¸è€…æ¥è¯´æ˜¯é€æ˜çš„ï¼Œ è¿™å°±è®©è¿™ä¸ªé—®é¢˜å˜å¾—å¾ˆéš¾ï¼Œå®ƒçš„è§£å†³æ–¹æ³•ä¸åœ¨æœ¬è¯¾ç¨‹è®¨è®ºèŒƒå›´ï¼Œä½ å¯ä»¥é˜…è¯» [è¿™ä¸ª StackOverflow ä¸Šçš„è®¨è®º](https://ethereum.stackexchange.com/questions/191/how-can-i-securely-generate-a-random-number-in-my-smart-contract) æ¥è·å¾—ä¸€äº›ä¸»æ„ã€‚ ä¸€ä¸ªæ–¹æ³•æ˜¯åˆ©ç”¨ **oracle** æ¥è®¿é—®ä»¥å¤ªåŠåŒºå—é“¾ä¹‹å¤–çš„éšæœºæ•°å‡½æ•°ã€‚

å½“ç„¶ï¼Œ å› ä¸ºç½‘ç»œä¸Šæˆåƒä¸Šä¸‡çš„ä»¥å¤ªåŠèŠ‚ç‚¹éƒ½åœ¨ç«äº‰è§£å†³ä¸‹ä¸€ä¸ªåŒºå—ï¼Œæˆ‘èƒ½æˆåŠŸè§£å†³ä¸‹ä¸€ä¸ªåŒºå—çš„å‡ ç‡éå¸¸ä¹‹ä½ã€‚ è¿™å°†èŠ±è´¹æˆ‘ä»¬å·¨å¤§çš„è®¡ç®—èµ„æºæ¥å¼€å‘è¿™ä¸ªè·åˆ©æ–¹æ³• â€” ä½†æ˜¯å¦‚æœå¥–åŠ±å¼‚å¸¸åœ°é«˜(æ¯”å¦‚æˆ‘å¯ä»¥åœ¨ç¡¬å¸ç¿»è½¬å‡½æ•°ä¸­èµ¢å¾— 1ä¸ªäº¿)ï¼Œ é‚£å°±å¾ˆå€¼å¾—å»æ”»å‡»äº†ã€‚

æ‰€ä»¥å°½ç®¡è¿™ä¸ªæ–¹æ³•åœ¨ä»¥å¤ªåŠä¸Šä¸å®‰å…¨ï¼Œåœ¨å®é™…ä¸­ï¼Œé™¤éæˆ‘ä»¬çš„éšæœºå‡½æ•°æœ‰ä¸€å¤§ç¬”é’±åœ¨ä¸Šé¢ï¼Œä½ æ¸¸æˆçš„ç”¨æˆ·ä¸€èˆ¬æ˜¯æ²¡æœ‰è¶³å¤Ÿçš„èµ„æºå»æ”»å‡»çš„ã€‚

å› ä¸ºåœ¨è¿™ä¸ªæ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬åªæ˜¯åœ¨ç¼–å†™ä¸€ä¸ªç®€å•çš„æ¸¸æˆæ¥åšæ¼”ç¤ºï¼Œä¹Ÿæ²¡æœ‰çœŸæ­£çš„é’±åœ¨é‡Œé¢ï¼Œæ‰€ä»¥æˆ‘ä»¬å†³å®šæ¥å—è¿™ä¸ªä¸è¶³ä¹‹å¤„ï¼Œä½¿ç”¨è¿™ä¸ªç®€å•çš„éšæœºæ•°ç”Ÿæˆå‡½æ•°ã€‚ä½†æ˜¯è¦è°¨è®°å®ƒæ˜¯ä¸å®‰å…¨çš„ã€‚

### å®æˆ˜æ¼”ä¹ 

æˆ‘ä»¬æ¥å®ç°ä¸€ä¸ªéšæœºæ•°ç”Ÿæˆå‡½æ•°ï¼Œå¥½æ¥è®¡ç®—æˆ˜æ–—çš„ç»“æœã€‚è™½ç„¶è¿™ä¸ªå‡½æ•°ä¸€ç‚¹å„¿ä¹Ÿä¸å®‰å…¨ã€‚

1. ç»™æˆ‘ä»¬åˆçº¦ä¸€ä¸ªåä¸º `randNonce` çš„ `uint`ï¼Œå°†å…¶å€¼è®¾ç½®ä¸º `0`ã€‚
2. å»ºç«‹ä¸€ä¸ªå‡½æ•°ï¼Œå‘½åä¸º `randMod` (random-modulus)ã€‚å®ƒå°†ä½œä¸º`internal` å‡½æ•°ï¼Œä¼ å…¥ä¸€ä¸ªåä¸º `_modulus`çš„ `uint`ï¼Œå¹¶ `returns` ä¸€ä¸ª `uint`ã€‚
3. è¿™ä¸ªå‡½æ•°é¦–å…ˆå°†ä¸º `randNonce`åŠ ä¸€ï¼Œ (ä½¿ç”¨ `randNonce++` è¯­å¥)ã€‚
4. æœ€åï¼Œå®ƒåº”è¯¥ (åœ¨ä¸€è¡Œä»£ç ä¸­) è®¡ç®— `now`, `msg.sender`, ä»¥åŠ `randNonce` çš„ `keccak256` å“ˆå¸Œå€¼å¹¶è½¬æ¢ä¸º `uint`â€”â€” æœ€å `return``% _modulus` çš„å€¼ã€‚ ï¼ˆå¤©! å¬èµ·æ¥å¤ªæ‹—å£äº†ã€‚å¦‚æœä½ æœ‰ç‚¹ç†è§£ä¸è¿‡æ¥ï¼Œçœ‹ä¸€ä¸‹æˆ‘ä»¬ä¸Šé¢è®¡ç®—éšæœºæ•°çš„ä¾‹å­ï¼Œå®ƒä»¬çš„é€»è¾‘éå¸¸ç›¸ä¼¼ï¼‰

```solidity
pragma solidity ^0.4.19;

import "./zombiehelper.sol";

contract ZombieBattle is ZombieHelper {
  // åœ¨è¿™é‡Œå¼€å§‹
  uint randNonce = 0;

  function randMod(uint _modulus) internal returns (uint) {
    randNonce++;
    return uint(keccak256(now, msg.sender, randNonce)) % _modulus;
  }
}

```

## ç¬¬5ç« : åƒµå°¸å¯¹æˆ˜

æˆ‘ä»¬çš„åˆçº¦å·²ç»æœ‰äº†ä¸€äº›éšæœºæ€§çš„æ¥æºï¼Œå¯ä»¥ç”¨è¿›æˆ‘ä»¬çš„åƒµå°¸æˆ˜æ–—ä¸­å»è®¡ç®—ç»“æœã€‚

æˆ‘ä»¬çš„åƒµå°¸æˆ˜æ–—çœ‹èµ·æ¥å°†æ˜¯è¿™ä¸ªæµç¨‹ï¼š

- ä½ é€‰æ‹©ä¸€ä¸ªè‡ªå·±çš„åƒµå°¸ï¼Œç„¶åé€‰æ‹©ä¸€ä¸ªå¯¹æ‰‹çš„åƒµå°¸å»æ”»å‡»ã€‚
- å¦‚æœä½ æ˜¯æ”»å‡»æ–¹ï¼Œä½ å°†æœ‰70%çš„å‡ ç‡è·èƒœï¼Œé˜²å®ˆæ–¹å°†æœ‰30%çš„å‡ ç‡è·èƒœã€‚
- æ‰€æœ‰çš„åƒµå°¸ï¼ˆæ”»å®ˆåŒæ–¹ï¼‰éƒ½å°†æœ‰ä¸€ä¸ª `winCount` å’Œä¸€ä¸ª `lossCount`ï¼Œè¿™ä¸¤ä¸ªå€¼éƒ½å°†æ ¹æ®æˆ˜æ–—ç»“æœå¢é•¿ã€‚
- è‹¥æ”»å‡»æ–¹è·èƒœï¼Œè¿™ä¸ªåƒµå°¸å°†å‡çº§å¹¶äº§ç”Ÿä¸€ä¸ªæ–°åƒµå°¸ã€‚
- å¦‚æœæ”»å‡»æ–¹å¤±è´¥ï¼Œé™¤äº†å¤±è´¥æ¬¡æ•°å°†åŠ ä¸€å¤–ï¼Œä»€ä¹ˆéƒ½ä¸ä¼šå‘ç”Ÿã€‚
- æ— è®ºè¾“èµ¢ï¼Œå½“å‰åƒµå°¸çš„å†·å´æ—¶é—´éƒ½å°†è¢«æ¿€æ´»ã€‚

è¿™æœ‰ä¸€å¤§å †çš„é€»è¾‘éœ€è¦å¤„ç†ï¼Œæˆ‘ä»¬å°†æŠŠè¿™äº›æ­¥éª¤åˆ†è§£åˆ°æ¥ä¸‹æ¥çš„è¯¾ç¨‹ä¸­å»ã€‚

### å®æˆ˜æ¼”ä¹ 

1. ç»™æˆ‘ä»¬åˆçº¦ä¸€ä¸ª `uint` ç±»å‹çš„å˜é‡ï¼Œå‘½åä¸º `attackVictoryProbability`, å°†å…¶å€¼è®¾å®šä¸º `70`ã€‚
2. åˆ›å»ºä¸€ä¸ªåä¸º `attack`çš„å‡½æ•°ã€‚å®ƒå°†ä¼ å…¥ä¸¤ä¸ªå‚æ•°: `_zombieId` (`uint`ç±»å‹) ä»¥åŠ `_targetId` (ä¹Ÿæ˜¯ `uint`)ã€‚å®ƒå°†æ˜¯ä¸€ä¸ª `external` å‡½æ•°ã€‚

å‡½æ•°ä½“å…ˆç•™ç©ºå§ã€‚

```
pragma solidity ^0.4.19;

import "./zombiehelper.sol";

contract ZombieBattle is ZombieHelper {
  uint randNonce = 0;
  // åœ¨è¿™é‡Œåˆ›å»º attackVictoryProbability
  uint attackVictoryProbability = 70;

  function randMod(uint _modulus) internal returns(uint) {
    randNonce++;
    return uint(keccak256(now, msg.sender, randNonce)) % _modulus;
  }

  // åœ¨è¿™é‡Œåˆ›å»ºæ–°å‡½æ•°
  function attack(uint _zombieId, uint _targetId) external {
  
  }

}

```

## ç¬¬6ç« : é‡æ„é€šç”¨é€»è¾‘

ä¸ç®¡è°è°ƒç”¨æˆ‘ä»¬çš„ `attack` å‡½æ•° â€”â€” æˆ‘ä»¬æƒ³ç¡®ä¿ç”¨æˆ·çš„ç¡®æ‹¥æœ‰ä»–ä»¬ç”¨æ¥æ”»å‡»çš„åƒµå°¸ã€‚å¦‚æœä½ èƒ½ç”¨å…¶ä»–äººçš„åƒµå°¸æ¥æ”»å‡»å°†æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„å®‰å…¨é—®é¢˜ã€‚

ä½ èƒ½æƒ³ä¸€ä¸‹æˆ‘ä»¬å¦‚ä½•æ·»åŠ ä¸€ä¸ªæ£€æŸ¥æ­¥éª¤æ¥çœ‹çœ‹è°ƒç”¨è¿™ä¸ªå‡½æ•°çš„äººå°±æ˜¯ä»–ä»¬ä¼ å…¥çš„ `_zombieId` çš„æ‹¥æœ‰è€…ä¹ˆï¼Ÿ

æƒ³ä¸€æƒ³ï¼Œçœ‹çœ‹ä½ èƒ½ä¸èƒ½è‡ªå·±æ‰¾åˆ°ä¸€äº›ç­”æ¡ˆã€‚

èŠ±ç‚¹æ—¶é—´â€¦â€¦ å‚è€ƒæˆ‘ä»¬å‰é¢è¯¾ç¨‹çš„ä»£ç æ¥è·å¾—çµæ„Ÿã€‚

ç­”æ¡ˆåœ¨ä¸‹é¢ï¼Œåœ¨ä½ æœ‰ä¸€äº›æƒ³æ³•ä¹‹å‰ä¸è¦ç»§ç»­é˜…è¯»ã€‚

### ç­”æ¡ˆ

æˆ‘ä»¬åœ¨å‰é¢çš„è¯¾ç¨‹é‡Œé¢å·²ç»åšè¿‡å¾ˆå¤šæ¬¡è¿™æ ·çš„æ£€æŸ¥äº†ã€‚ åœ¨ `changeName()`, `changeDna()`, å’Œ `feedAndMultiply()`é‡Œï¼Œæˆ‘ä»¬åšè¿‡è¿™æ ·çš„æ£€æŸ¥ï¼š

```
require(msg.sender == zombieToOwner[_zombieId]);
```

è¿™å’Œæˆ‘ä»¬ `attack` å‡½æ•°å°†è¦ç”¨åˆ°çš„æ£€æŸ¥é€»è¾‘æ˜¯ç›¸åŒçš„ã€‚ æ­£å› æˆ‘ä»¬è¦å¤šæ¬¡è°ƒç”¨è¿™ä¸ªæ£€æŸ¥é€»è¾‘ï¼Œè®©æˆ‘ä»¬æŠŠå®ƒç§»åˆ°å®ƒè‡ªå·±çš„ `modifier` ä¸­æ¥æ¸…ç†ä»£ç å¹¶é¿å…é‡å¤ç¼–ç ã€‚

### å®æˆ˜æ¼”ä¹ 

æˆ‘ä»¬å›åˆ°äº† `zombiefeeding.sol`ï¼Œ å› ä¸ºè¿™æ˜¯æˆ‘ä»¬ç¬¬ä¸€æ¬¡è°ƒç”¨æ£€æŸ¥é€»è¾‘çš„åœ°æ–¹ã€‚è®©æˆ‘ä»¬æŠŠå®ƒé‡æ„è¿›å®ƒè‡ªå·±çš„ `modifier`ã€‚

1. åˆ›å»ºä¸€ä¸ª `modifier`ï¼Œ å‘½åä¸º `ownerOf`ã€‚å®ƒå°†ä¼ å…¥ä¸€ä¸ªå‚æ•°ï¼Œ `_zombieId` (ä¸€ä¸ª `uint`)ã€‚

   å®ƒçš„å‡½æ•°ä½“åº”è¯¥ `require` `msg.sender` ç­‰äº `zombieToOwner[_zombieId]`ï¼Œ ç„¶åç»§ç»­è¿™ä¸ªå‡½æ•°å‰©ä¸‹çš„å†…å®¹ã€‚ å¦‚æœä½ å¿˜è®°äº†ä¿®é¥°ç¬¦çš„å†™æ³•ï¼Œå¯ä»¥å‚è€ƒ `zombiehelper.sol`ã€‚

2. å°†è¿™ä¸ªå‡½æ•°çš„ `feedAndMultiply` å®šä¹‰ä¿®æ”¹ä¸ºå…¶ä½¿ç”¨ä¿®é¥°ç¬¦ `ownerOf`ã€‚

3. ç°åœ¨æˆ‘ä»¬ä½¿ç”¨ `modifier`äº†ï¼Œä½ å¯ä»¥åˆ é™¤è¿™è¡Œäº†ï¼š `require(msg.sender == zombieToOwner[_zombieId]);`

```
pragma solidity ^0.4.19;

import "./zombiefactory.sol";

contract KittyInterface {
  function getKitty(uint256 _id) external view returns (
    bool isGestating,
    bool isReady,
    uint256 cooldownIndex,
    uint256 nextActionAt,
    uint256 siringWithId,
    uint256 birthTime,
    uint256 matronId,
    uint256 sireId,
    uint256 generation,
    uint256 genes
  );
}

contract ZombieFeeding is ZombieFactory {

  KittyInterface kittyContract;

  // 1. åœ¨è¿™é‡Œåˆ›å»º modifier
  modifier ownerOf(uint _zombieId) {
    require(msg.sender == zombieToOwner[_zombieId]);
    _;
  }

  function setKittyContractAddress(address _address) external onlyOwner {
    kittyContract = KittyInterface(_address);
  }

  function _triggerCooldown(Zombie storage _zombie) internal {
    _zombie.readyTime = uint32(now + cooldownTime);
  }

  function _isReady(Zombie storage _zombie) internal view returns (bool) {
      return (_zombie.readyTime <= now);
  }

  // 2. åœ¨å‡½æ•°å®šä¹‰æ—¶å¢åŠ  modifier :
  function feedAndMultiply(uint _zombieId, uint _targetDna, string _species) internal ownerOf(_zombieId) {
    // 3. ç§»é™¤è¿™ä¸€è¡Œ
    //require(msg.sender == zombieToOwner[_zombieId]);
    Zombie storage myZombie = zombies[_zombieId];
    require(_isReady(myZombie));
    _targetDna = _targetDna % dnaModulus;
    uint newDna = (myZombie.dna + _targetDna) / 2;
    if (keccak256(_species) == keccak256("kitty")) {
      newDna = newDna - newDna % 100 + 99;
    }
    _createZombie("NoName", newDna);
    _triggerCooldown(myZombie);
  }

  function feedOnKitty(uint _zombieId, uint _kittyId) public {
    uint kittyDna;
    (,,,,,,,,,kittyDna) = kittyContract.getKitty(_kittyId);
    feedAndMultiply(_zombieId, kittyDna, "kitty");
  }
}

```

## ç¬¬7ç« : æ›´å¤šé‡æ„

åœ¨ `zombiehelper.sol`é‡Œæœ‰å‡ å¤„åœ°æ–¹ï¼Œéœ€è¦æˆ‘ä»¬å®ç°æˆ‘ä»¬æ–°çš„ `modifier`â€”â€” `ownerOf`ã€‚

### å®æˆ˜æ¼”ä¹ 

1. ä¿®æ”¹ `changeName()` ä½¿å…¶ä½¿ç”¨ `ownerOf`
2. ä¿®æ”¹ `changeDna()` ä½¿å…¶ä½¿ç”¨ `ownerOf`

```
pragma solidity ^0.4.19;

import "./zombiefeeding.sol";

contract ZombieHelper is ZombieFeeding {

  uint levelUpFee = 0.001 ether;

  modifier aboveLevel(uint _level, uint _zombieId) {
    require(zombies[_zombieId].level >= _level);
    _;
  }

  function withdraw() external onlyOwner {
    owner.transfer(this.balance);
  }

  function setLevelUpFee(uint _fee) external onlyOwner {
    levelUpFee = _fee;
  }

  function levelUp(uint _zombieId) external payable {
    require(msg.value == levelUpFee);
    zombies[_zombieId].level++;
  }

  // 1. ä½¿ç”¨ `ownerOf` ä¿®æ”¹è¿™ä¸ªå‡½æ•°:
  function changeName(uint _zombieId, string _newName) external aboveLevel(2, _zombieId) ownerOf(_zombieId) {
    //require(msg.sender == zombieToOwner[_zombieId]);
    zombies[_zombieId].name = _newName;
  }

  // 2. å¯¹è¿™ä¸ªå‡½æ•°åšåŒæ ·çš„äº‹:
  function changeDna(uint _zombieId, uint _newDna) external aboveLevel(20, _zombieId) ownerOf(_zombieId) {
    //require(msg.sender == zombieToOwner[_zombieId]);
    zombies[_zombieId].dna = _newDna;
  }

  function getZombiesByOwner(address _owner) external view returns(uint[]) {
    uint[] memory result = new uint[](ownerZombieCount[_owner]);
    uint counter = 0;
    for (uint i = 0; i < zombies.length; i++) {
      if (zombieToOwner[i] == _owner) {
        result[counter] = i;
        counter++;
      }
    }
    return result;
  }

}

```

## ç¬¬8ç« : å›åˆ°æ”»å‡»ï¼

é‡æ„å®Œæˆäº†ï¼Œå›åˆ° `zombieattack.sol`ã€‚

ç»§ç»­æ¥å®Œå–„æˆ‘ä»¬çš„ `attack` å‡½æ•°ï¼Œ ç°åœ¨æˆ‘ä»¬æœ‰äº† `ownerOf` ä¿®é¥°ç¬¦æ¥ç”¨äº†ã€‚

### å®æˆ˜æ¼”ä¹ 

1. å°† `ownerOf` ä¿®é¥°ç¬¦æ·»åŠ åˆ° `attack` æ¥ç¡®ä¿è°ƒç”¨è€…æ‹¥æœ‰`_zombieId`.

2. æˆ‘ä»¬çš„å‡½æ•°æ‰€éœ€è¦åšçš„ç¬¬ä¸€ä»¶äº‹å°±æ˜¯è·å¾—ä¸€ä¸ªåŒæ–¹åƒµå°¸çš„ `storage` æŒ‡é’ˆï¼Œ è¿™æ ·æˆ‘ä»¬æ‰èƒ½å¾ˆæ–¹ä¾¿å’Œå®ƒä»¬äº¤äº’ï¼š

   a. å®šä¹‰ä¸€ä¸ª `Zombie storage` å‘½åä¸º `myZombie`ï¼Œä½¿å…¶å€¼ç­‰äº `zombies[_zombieId]`ã€‚

   b. å®šä¹‰ä¸€ä¸ª `Zombie storage` å‘½åä¸º `enemyZombie`ï¼Œ ä½¿å…¶å€¼ç­‰äº`zombies[_targetId]`ã€‚

3. æˆ‘ä»¬å°†ç”¨ä¸€ä¸ª0åˆ°100çš„éšæœºæ•°æ¥ç¡®å®šæˆ‘ä»¬çš„æˆ˜æ–—ç»“æœã€‚ å®šä¹‰ä¸€ä¸ª `uint`ï¼Œå‘½åä¸º `rand`ï¼Œ è®¾å®šå…¶å€¼ç­‰äº `randMod` å‡½æ•°çš„è¿”å›å€¼ï¼Œæ­¤å‡½æ•°ä¼ å…¥ `100`ä½œä¸ºå‚æ•°ã€‚

```solidity
pragma solidity ^0.4.19;

import "./zombiehelper.sol";

contract ZombieBattle is ZombieHelper {
  uint randNonce = 0;
  uint attackVictoryProbability = 70;

  function randMod(uint _modulus) internal returns(uint) {
    randNonce++;
    return uint(keccak256(now, msg.sender, randNonce)) % _modulus;
  }

  // 1. åœ¨è¿™é‡Œå¢åŠ  modifier
  function attack(uint _zombieId, uint _targetId) external ownerOf(_zombieId) {
    // 2. åœ¨è¿™é‡Œå¼€å§‹å®šä¹‰å‡½æ•°
    Zombie storage myZombie = zombies[_zombieId];
    Zombie storage enemyZombie = zombies[_targetId];
    uint rand = randMod(100);
  }
}

```

## ç¬¬9ç« : åƒµå°¸çš„è¾“èµ¢

å¯¹æˆ‘ä»¬çš„åƒµå°¸æ¸¸æˆæ¥è¯´ï¼Œæˆ‘ä»¬å°†è¦è¿½è¸ªæˆ‘ä»¬çš„åƒµå°¸è¾“èµ¢äº†å¤šå°‘åœºã€‚æœ‰äº†è¿™ä¸ªæˆ‘ä»¬å¯ä»¥åœ¨æ¸¸æˆé‡Œç»´æŠ¤ä¸€ä¸ª "åƒµå°¸æ’è¡Œæ¦œ"ã€‚

æœ‰å¤šç§æ–¹æ³•åœ¨æˆ‘ä»¬çš„DAppé‡Œé¢ä¿å­˜ä¸€ä¸ªæ•°å€¼ â€” ä½œä¸ºä¸€ä¸ªå•ç‹¬çš„æ˜ å°„ï¼Œä½œä¸ºä¸€ä¸ªâ€œæ’è¡Œæ¦œâ€ç»“æ„ä½“ï¼Œæˆ–è€…ä¿å­˜åœ¨ `Zombie` ç»“æ„ä½“å†…ã€‚

æ¯ä¸ªæ–¹æ³•éƒ½æœ‰å…¶ä¼˜ç¼ºç‚¹ï¼Œå–å†³äºæˆ‘ä»¬æ‰“ç®—å¦‚ä½•å’Œè¿™äº›æ•°æ®æ‰“äº¤é“ã€‚åœ¨è¿™ä¸ªæ•™ç¨‹ä¸­ï¼Œç®€å•èµ·è§æˆ‘ä»¬å°†è¿™ä¸ªçŠ¶æ€ä¿å­˜åœ¨ `Zombie` ç»“æ„ä½“ä¸­ï¼Œå°†å…¶å‘½åä¸º `winCount` å’Œ `lossCount`ã€‚

æˆ‘ä»¬è·³å› `zombiefactory.sol`, å°†è¿™äº›å±æ€§æ·»åŠ è¿› `Zombie` ç»“æ„ä½“.

### å®æˆ˜æ¼”ä¹ 

1. ä¿®æ”¹ `Zombie` ç»“æ„ä½“ï¼Œæ·»åŠ ä¸¤ä¸ªå±æ€§:

   a. `winCount`, ä¸€ä¸ª `uint16`

   b. `lossCount`, ä¹Ÿæ˜¯ä¸€ä¸ª `uint16`

   > æ³¨æ„ï¼š è®°ä½, å› ä¸ºæˆ‘ä»¬èƒ½åœ¨ç»“æ„ä½“ä¸­åŒ…è£…`uint`, æˆ‘ä»¬æ‰“ç®—ç”¨é€‚åˆæˆ‘ä»¬çš„æœ€å°çš„ `uint`ã€‚ ä¸€ä¸ª `uint8` å¤ªå°äº†ï¼Œ å› ä¸º 2^8 = 256 â€”â€” å¦‚æœæˆ‘ä»¬çš„åƒµå°¸æ¯å¤©éƒ½ä½œæˆ˜ï¼Œä¸åˆ°ä¸€å¹´å°±æº¢å‡ºäº†ã€‚ä½†æ˜¯ 2^16 = 65536 ï¼ˆ`uint16`ï¼‰â€”â€” é™¤éä¸€ä¸ªåƒµå°¸è¿ç»­179å¹´æ¯å¤©ä½œæˆ˜ï¼Œå¦åˆ™æˆ‘ä»¬å°±æ˜¯å®‰å…¨çš„ã€‚

2. ç°åœ¨æˆ‘ä»¬çš„ `Zombie` ç»“æ„ä½“æœ‰äº†æ–°çš„å±æ€§ï¼Œ æˆ‘ä»¬éœ€è¦ä¿®æ”¹ `_createZombie()` ä¸­çš„å‡½æ•°å®šä¹‰ã€‚

   ä¿®æ”¹åƒµå°¸ç”Ÿæˆå®šä¹‰ï¼Œè®©æ¯ä¸ªæ–°åƒµå°¸éƒ½æœ‰ `0` èµ¢å’Œ `0` è¾“ã€‚

```
pragma solidity ^0.4.19;

import "./ownable.sol";

contract ZombieFactory is Ownable {

    event NewZombie(uint zombieId, string name, uint dna);

    uint dnaDigits = 16;
    uint dnaModulus = 10 ** dnaDigits;
    uint cooldownTime = 1 days;

    struct Zombie {
      string name;
      uint dna;
      uint32 level;
      uint32 readyTime;
      // 1. åœ¨è¿™é‡Œæ·»åŠ æ–°çš„å±æ€§
      uint16 winCount;
      uint16 lossCount;
    }

    Zombie[] public zombies;

    mapping (uint => address) public zombieToOwner;
    mapping (address => uint) ownerZombieCount;

    function _createZombie(string _name, uint _dna) internal {
        // 2. åœ¨è¿™é‡Œä¿®æ”¹ä¿®æ”¹æ–°åƒµå°¸çš„åˆ›å»º:
        uint id = zombies.push(Zombie(_name, _dna, 1, uint32(now + cooldownTime), 0, 0)) - 1;
        zombieToOwner[id] = msg.sender;
        ownerZombieCount[msg.sender]++;
        NewZombie(id, _name, _dna);
    }

    function _generateRandomDna(string _str) private view returns (uint) {
        uint rand = uint(keccak256(_str));
        return rand % dnaModulus;
    }

    function createRandomZombie(string _name) public {
        require(ownerZombieCount[msg.sender] == 0);
        uint randDna = _generateRandomDna(_name);
        randDna = randDna - randDna % 100;
        _createZombie(_name, randDna);
    }

}

```

## ç¬¬10ç« : åƒµå°¸èƒœåˆ©äº† ğŸ˜„

æœ‰äº† `winCount` å’Œ `lossCount`ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®åƒµå°¸å“ªä¸ªåƒµå°¸èµ¢äº†æˆ˜æ–—æ¥æ›´æ–°å®ƒä»¬äº†ã€‚

åœ¨ç¬¬å…­ç« æˆ‘ä»¬è®¡ç®—å‡ºæ¥ä¸€ä¸ª0åˆ°100çš„éšæœºæ•°ã€‚ç°åœ¨è®©æˆ‘ä»¬ç”¨é‚£ä¸ªæ•°æ¥å†³å®šé‚£è°èµ¢äº†æˆ˜æ–—ï¼Œå¹¶ä»¥æ­¤æ›´æ–°æˆ‘ä»¬çš„çŠ¶æ€ã€‚

### å®æˆ˜æ¼”ä¹ 

1. åˆ›å»ºä¸€ä¸ª `if` è¯­å¥æ¥æ£€æŸ¥ `rand` æ˜¯ä¸æ˜¯ **å°äºæˆ–è€…ç­‰äº**`attackVictoryProbability`ã€‚

2. å¦‚æœä»¥ä¸Šæ¡ä»¶ä¸º `true`ï¼Œ æˆ‘ä»¬çš„åƒµå°¸å°±èµ¢äº†ï¼æ‰€ä»¥ï¼š

   a. å¢åŠ  `myZombie` çš„ `winCount`ã€‚

   b. å¢åŠ  `myZombie` çš„ `level`ã€‚ (å‡çº§äº†å•¦!!!!!!!)

   c. å¢åŠ  `enemyZombie` çš„ `lossCount`. (è¾“å®¶!!!!!! ğŸ˜« ğŸ˜« ğŸ˜«)

   d. è¿è¡Œ `feedAndMultiply` å‡½æ•°ã€‚ åœ¨ `zombiefeeding.sol` é‡ŒæŸ¥çœ‹è°ƒç”¨å®ƒçš„è¯­å¥ã€‚ å¯¹äºç¬¬ä¸‰ä¸ªå‚æ•° (`_species`)ï¼Œä¼ å…¥å­—ç¬¦ä¸² "zombie". ï¼ˆç°åœ¨å®ƒå®é™…ä¸Šä»€ä¹ˆéƒ½ä¸åšï¼Œä¸è¿‡åœ¨ç¨åï¼Œ å¦‚æœæˆ‘ä»¬æ„¿æ„ï¼Œå¯ä»¥æ·»åŠ é¢å¤–çš„æ–¹æ³•ï¼Œç”¨æ¥åˆ¶é€ åƒµå°¸å˜çš„åƒµå°¸ï¼‰ã€‚

```solidity
pragma solidity ^0.4.19;

import "./zombiehelper.sol";

contract ZombieBattle is ZombieHelper {
  uint randNonce = 0;
  uint attackVictoryProbability = 70;

  function randMod(uint _modulus) internal returns(uint) {
    randNonce++;
    return uint(keccak256(now, msg.sender, randNonce)) % _modulus;
  }

  function attack(uint _zombieId, uint _targetId) external ownerOf(_zombieId) {
    Zombie storage myZombie = zombies[_zombieId];
    Zombie storage enemyZombie = zombies[_targetId];
    uint rand = randMod(100);
    // åœ¨è¿™é‡Œå¼€å§‹
    if (rand <= attackVictoryProbability) {
      myZombie.winCount++;
      myZombie.level++;
      enemyZombie.lossCount++;
      feedAndMultiply(_zombieId, enemyZombie.dna, "zombie");
    }
  }
}

```

## ç¬¬11ç« : åƒµå°¸å¤±è´¥ ğŸ˜

æˆ‘ä»¬å·²ç»ç¼–å†™äº†ä½ çš„åƒµå°¸èµ¢äº†ä¹‹åä¼šå‘ç”Ÿä»€ä¹ˆï¼Œ è¯¥çœ‹çœ‹ **è¾“äº†** çš„æ—¶å€™è¦æ€ä¹ˆåšäº†ã€‚

åœ¨æˆ‘ä»¬çš„æ¸¸æˆä¸­ï¼Œåƒµå°¸è¾“äº†åå¹¶ä¸ä¼šé™çº§ â€”â€” åªæ˜¯ç®€å•åœ°ç»™ `lossCount` åŠ ä¸€ï¼Œå¹¶è§¦å‘å†·å´ï¼Œç­‰å¾…ä¸€å¤©åæ‰èƒ½å†æ¬¡å‚æˆ˜ã€‚

è¦å®ç°è¿™ä¸ªé€»è¾‘ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ª `else` è¯­å¥ã€‚

`else` è¯­å¥å’Œ JavaScript ä»¥åŠå¾ˆå¤šå…¶ä»–è¯­è¨€çš„ else è¯­å¥ä¸€æ ·ã€‚

```
if (zombieCoins[msg.sender] > 100000000) {
  // ä½ å¥½æœ‰é’±!!!
} else {
  // æˆ‘ä»¬éœ€è¦æ›´å¤šçš„åƒµå°¸å¸...
}
```

### å®æˆ˜æ¼”ä¹ 

1. æ·»åŠ ä¸€ä¸ª `else` è¯­å¥ã€‚ è‹¥æˆ‘ä»¬çš„åƒµå°¸è¾“äº†ï¼š

   a. å¢åŠ  `myZombie` çš„ `lossCount`ã€‚

   b. å¢åŠ  `enemyZombie` çš„ `winCount`ã€‚

2. åœ¨ `else` æœ€åï¼Œ å¯¹ `myZombie` è¿è¡Œ `_triggerCooldown` æ–¹æ³•ã€‚è¿™è®©æ¯ä¸ªåƒµå°¸æ¯å¤©åªèƒ½å‚æˆ˜ä¸€æ¬¡ã€‚

```solidity
pragma solidity ^0.4.19;

import "./zombiehelper.sol";

contract ZombieBattle is ZombieHelper {
  uint randNonce = 0;
  uint attackVictoryProbability = 70;

  function randMod(uint _modulus) internal returns(uint) {
    randNonce++;
    return uint(keccak256(now, msg.sender, randNonce)) % _modulus;
  }

  function attack(uint _zombieId, uint _targetId) external ownerOf(_zombieId) {
    Zombie storage myZombie = zombies[_zombieId];
    Zombie storage enemyZombie = zombies[_targetId];
    uint rand = randMod(100);
    if (rand <= attackVictoryProbability) {
      myZombie.winCount++;
      myZombie.level++;
      enemyZombie.lossCount++;
      feedAndMultiply(_zombieId, enemyZombie.dna, "zombie");
    } else {// åœ¨è¿™é‡Œå¼€å§‹ 
      myZombie.lossCount++;
      enemyZombie.winCount++;
      _triggerCooldown(myZombie);
    }
  }
}

```

# äº”ã€ERC721 æ ‡å‡†å’ŒåŠ å¯†æ”¶è—å“

## ç¬¬1ç« : ä»¥å¤ªåŠä¸Šçš„ä»£å¸

è®©æˆ‘ä»¬æ¥èŠèŠ **ä»£å¸**.

å¦‚æœä½ å¯¹ä»¥å¤ªåŠçš„ä¸–ç•Œæœ‰ä¸€äº›äº†è§£ï¼Œä½ å¾ˆå¯èƒ½å¬è¿‡äººä»¬èŠåˆ°ä»£å¸â€”â€”å°¤å…¶æ˜¯ **ERC20 ä»£å¸**.

ä¸€ä¸ª **ä»£å¸** åœ¨ä»¥å¤ªåŠåŸºæœ¬ä¸Šå°±æ˜¯ä¸€ä¸ªéµå¾ªä¸€äº›å…±åŒè§„åˆ™çš„æ™ºèƒ½åˆçº¦â€”â€”å³å®ƒå®ç°äº†æ‰€æœ‰å…¶ä»–ä»£å¸åˆçº¦å…±äº«çš„ä¸€ç»„æ ‡å‡†å‡½æ•°ï¼Œä¾‹å¦‚ `transfer(address _to, uint256 _value)`å’Œ `balanceOf(address _owner)`.

åœ¨æ™ºèƒ½åˆçº¦å†…éƒ¨ï¼Œé€šå¸¸æœ‰ä¸€ä¸ªæ˜ å°„ï¼Œ `mapping(address => uint256) balances`ï¼Œç”¨äºè¿½è¸ªæ¯ä¸ªåœ°å€è¿˜æœ‰å¤šå°‘ä½™é¢ã€‚

æ‰€ä»¥åŸºæœ¬ä¸Šä¸€ä¸ªä»£å¸åªæ˜¯ä¸€ä¸ªè¿½è¸ªè°æ‹¥æœ‰å¤šå°‘è¯¥ä»£å¸çš„åˆçº¦ï¼Œå’Œä¸€äº›å¯ä»¥è®©é‚£äº›ç”¨æˆ·å°†ä»–ä»¬çš„ä»£å¸è½¬ç§»åˆ°å…¶ä»–åœ°å€çš„å‡½æ•°ã€‚

### å®ƒä¸ºä»€ä¹ˆé‡è¦å‘¢ï¼Ÿ

ç”±äºæ‰€æœ‰ ERC20 ä»£å¸å…±äº«å…·æœ‰ç›¸åŒåç§°çš„åŒä¸€ç»„å‡½æ•°ï¼Œå®ƒä»¬éƒ½å¯ä»¥ä»¥ç›¸åŒçš„æ–¹å¼è¿›è¡Œäº¤äº’ã€‚

è¿™æ„å‘³ç€å¦‚æœä½ æ„å»ºçš„åº”ç”¨ç¨‹åºèƒ½å¤Ÿä¸ä¸€ä¸ª ERC20 ä»£å¸è¿›è¡Œäº¤äº’ï¼Œé‚£ä¹ˆå®ƒå°±ä¹Ÿèƒ½å¤Ÿä¸ä»»ä½• ERC20 ä»£å¸è¿›è¡Œäº¤äº’ã€‚ è¿™æ ·ä¸€æ¥ï¼Œå°†æ¥ä½ å°±å¯ä»¥è½»æ¾åœ°å°†æ›´å¤šçš„ä»£å¸æ·»åŠ åˆ°ä½ çš„åº”ç”¨ä¸­ï¼Œè€Œæ— éœ€è¿›è¡Œè‡ªå®šä¹‰ç¼–ç ã€‚ ä½ å¯ä»¥ç®€å•åœ°æ’å…¥æ–°çš„ä»£å¸åˆçº¦åœ°å€ï¼Œç„¶åå“—å•¦ï¼Œä½ çš„åº”ç”¨ç¨‹åºæœ‰å¦ä¸€ä¸ªå®ƒå¯ä»¥ä½¿ç”¨çš„ä»£å¸äº†ã€‚

å…¶ä¸­ä¸€ä¸ªä¾‹å­å°±æ˜¯äº¤æ˜“æ‰€ã€‚ å½“äº¤æ˜“æ‰€æ·»åŠ ä¸€ä¸ªæ–°çš„ ERC20 ä»£å¸æ—¶ï¼Œå®é™…ä¸Šå®ƒåªéœ€è¦æ·»åŠ ä¸ä¹‹å¯¹è¯çš„å¦ä¸€ä¸ªæ™ºèƒ½åˆçº¦ã€‚ ç”¨æˆ·å¯ä»¥è®©é‚£ä¸ªåˆçº¦å°†ä»£å¸å‘é€åˆ°äº¤æ˜“æ‰€çš„é’±åŒ…åœ°å€ï¼Œç„¶åäº¤æ˜“æ‰€å¯ä»¥è®©åˆçº¦åœ¨ç”¨æˆ·è¦æ±‚å–æ¬¾æ—¶å°†ä»£å¸å‘é€å›ç»™ä»–ä»¬ã€‚

äº¤æ˜“æ‰€åªéœ€è¦å®ç°è¿™ç§è½¬ç§»é€»è¾‘ä¸€æ¬¡ï¼Œç„¶åå½“å®ƒæƒ³è¦æ·»åŠ ä¸€ä¸ªæ–°çš„ ERC20 ä»£å¸æ—¶ï¼Œåªéœ€å°†æ–°çš„åˆçº¦åœ°å€æ·»åŠ åˆ°å®ƒçš„æ•°æ®åº“å³å¯ã€‚

### å…¶ä»–ä»£å¸æ ‡å‡†

å¯¹äºåƒè´§å¸ä¸€æ ·çš„ä»£å¸æ¥è¯´ï¼ŒERC20 ä»£å¸éå¸¸é…·ã€‚ ä½†æ˜¯è¦åœ¨æˆ‘ä»¬åƒµå°¸æ¸¸æˆä¸­ä»£è¡¨åƒµå°¸å°±å¹¶ä¸æ˜¯ç‰¹åˆ«æœ‰ç”¨ã€‚

é¦–å…ˆï¼Œåƒµå°¸ä¸åƒè´§å¸å¯ä»¥åˆ†å‰² â€”â€” æˆ‘å¯ä»¥å‘ç»™ä½  0.237 ä»¥å¤ªï¼Œä½†æ˜¯è½¬ç§»ç»™ä½  0.237 çš„åƒµå°¸å¬èµ·æ¥å°±æœ‰äº›æç¬‘ã€‚

å…¶æ¬¡ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰åƒµå°¸éƒ½æ˜¯å¹³ç­‰çš„ã€‚ ä½ çš„2çº§åƒµå°¸"**Steve**"å®Œå…¨ä¸èƒ½ç­‰åŒäºæˆ‘732çº§çš„åƒµå°¸"**H4XF13LD MORRIS ğŸ’¯ğŸ’¯ğŸ˜ğŸ’¯ğŸ’¯**"ã€‚ï¼ˆä½ å·®å¾—è¿œå‘¢ï¼Œ*Steve*ï¼‰ã€‚

æœ‰å¦ä¸€ä¸ªä»£å¸æ ‡å‡†æ›´é€‚åˆå¦‚ CryptoZombies è¿™æ ·çš„åŠ å¯†æ”¶è—å“â€”â€”å®ƒä»¬è¢«ç§°ä¸º**ERC721 ä»£å¸.**

**ERC721 ä»£å¸**æ˜¯**ä¸**èƒ½äº’æ¢çš„ï¼Œå› ä¸ºæ¯ä¸ªä»£å¸éƒ½è¢«è®¤ä¸ºæ˜¯å”¯ä¸€ä¸”ä¸å¯åˆ†å‰²çš„ã€‚ ä½ åªèƒ½ä»¥æ•´ä¸ªå•ä½äº¤æ˜“å®ƒä»¬ï¼Œå¹¶ä¸”æ¯ä¸ªå•ä½éƒ½æœ‰å”¯ä¸€çš„ IDã€‚ è¿™äº›ç‰¹æ€§æ­£å¥½è®©æˆ‘ä»¬çš„åƒµå°¸å¯ä»¥ç”¨æ¥äº¤æ˜“ã€‚

> è¯·æ³¨æ„ï¼Œä½¿ç”¨åƒ ERC721 è¿™æ ·çš„æ ‡å‡†çš„ä¼˜åŠ¿å°±æ˜¯ï¼Œæˆ‘ä»¬ä¸å¿…åœ¨æˆ‘ä»¬çš„åˆçº¦ä¸­å®ç°æ‹å–æˆ–æ‰˜ç®¡é€»è¾‘ï¼Œè¿™å†³å®šäº†ç©å®¶èƒ½å¤Ÿå¦‚ä½•äº¤æ˜“ï¼å‡ºå”®æˆ‘ä»¬çš„åƒµå°¸ã€‚ å¦‚æœæˆ‘ä»¬ç¬¦åˆè§„èŒƒï¼Œå…¶ä»–äººå¯ä»¥ä¸ºåŠ å¯†å¯äº¤æ˜“çš„ ERC721 èµ„äº§æ­å»ºä¸€ä¸ªäº¤æ˜“æ‰€å¹³å°ï¼Œæˆ‘ä»¬çš„ ERC721 åƒµå°¸å°†å¯ä»¥åœ¨è¯¥å¹³å°ä¸Šä½¿ç”¨ã€‚ æ‰€ä»¥ä½¿ç”¨ä»£å¸æ ‡å‡†ç›¸è¾ƒäºä½¿ç”¨ä½ è‡ªå·±çš„äº¤æ˜“é€»è¾‘æœ‰æ˜æ˜¾çš„å¥½å¤„ã€‚

### å®æˆ˜æ¼”ä¹ 

æˆ‘ä»¬å°†åœ¨ä¸‹ä¸€ç« æ·±å…¥è®¨è®ºERC721çš„å®ç°ã€‚ ä½†é¦–å…ˆï¼Œè®©æˆ‘ä»¬ä¸ºæœ¬è¯¾è®¾ç½®æˆ‘ä»¬çš„æ–‡ä»¶ç»“æ„ã€‚

æˆ‘ä»¬å°†æŠŠæ‰€æœ‰ERC721é€»è¾‘å­˜å‚¨åœ¨ä¸€ä¸ªå«`ZombieOwnership`çš„åˆçº¦ä¸­ã€‚

1. åœ¨æ–‡ä»¶é¡¶éƒ¨å£°æ˜æˆ‘ä»¬`pragma`çš„ç‰ˆæœ¬ï¼ˆæ ¼å¼å‚è€ƒä¹‹å‰çš„è¯¾ç¨‹ï¼‰ã€‚
2. å°† `zombieattack.sol` `import` è¿›æ¥ã€‚
3. å£°æ˜ä¸€ä¸ªç»§æ‰¿ `ZombieAttack` çš„æ–°åˆçº¦ï¼Œ å‘½åä¸º`ZombieOwnership`ã€‚åˆçº¦çš„å…¶ä»–éƒ¨åˆ†å…ˆç•™ç©ºã€‚

zombieownership.sol

```
// ä»è¿™é‡Œå¼€å§‹
pragma solidity ^0.4.19;

import "./zombieattack.sol";

contract ZombieOwnership is ZombieAttack {
    
}
```

## ç¬¬2ç« : ERC721 æ ‡å‡†, å¤šé‡ç»§æ‰¿

è®©æˆ‘ä»¬æ¥çœ‹ä¸€çœ‹ ERC721 æ ‡å‡†ï¼š

```
contract ERC721 {
  event Transfer(address indexed _from, address indexed _to, uint256 _tokenId);
  event Approval(address indexed _owner, address indexed _approved, uint256 _tokenId);

  function balanceOf(address _owner) public view returns (uint256 _balance);
  function ownerOf(uint256 _tokenId) public view returns (address _owner);
  function transfer(address _to, uint256 _tokenId) public;
  function approve(address _to, uint256 _tokenId) public;
  function takeOwnership(uint256 _tokenId) public;
}
```

è¿™æ˜¯æˆ‘ä»¬éœ€è¦å®ç°çš„æ–¹æ³•åˆ—è¡¨ï¼Œæˆ‘ä»¬å°†åœ¨æ¥ä¸‹æ¥çš„ç« èŠ‚ä¸­é€ä¸ªå­¦ä¹ ã€‚

è™½ç„¶çœ‹èµ·æ¥å¾ˆå¤šï¼Œä½†ä¸è¦è¢«å“åˆ°äº†ï¼æˆ‘ä»¬åœ¨è¿™é‡Œå°±æ˜¯å‡†å¤‡å¸¦ç€ä½ ä¸€æ­¥ä¸€æ­¥äº†è§£å®ƒä»¬çš„ã€‚

> æ³¨æ„ï¼š ERC721ç›®å‰æ˜¯ä¸€ä¸ª *è‰ç¨¿*ï¼Œè¿˜æ²¡æœ‰æ­£å¼å•†å®šçš„å®ç°ã€‚åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ OpenZeppelin åº“ä¸­çš„å½“å‰ç‰ˆæœ¬ï¼Œä½†åœ¨æœªæ¥æ­£å¼å‘å¸ƒä¹‹å‰å®ƒå¯èƒ½ä¼šæœ‰æ›´æ”¹ã€‚ æ‰€ä»¥æŠŠè¿™ **ä¸€ä¸ª** å¯èƒ½çš„å®ç°å½“ä½œè€ƒè™‘ï¼Œä½†ä¸è¦æŠŠå®ƒä½œä¸º ERC721 ä»£å¸çš„å®˜æ–¹æ ‡å‡†ã€‚

### å®ç°ä¸€ä¸ªä»£å¸åˆçº¦

åœ¨å®ç°ä¸€ä¸ªä»£å¸åˆçº¦çš„æ—¶å€™ï¼Œæˆ‘ä»¬é¦–å…ˆè¦åšçš„æ˜¯å°†æ¥å£å¤åˆ¶åˆ°å®ƒè‡ªå·±çš„ Solidity æ–‡ä»¶å¹¶å¯¼å…¥å®ƒï¼Œ`import ./erc721.sol`ã€‚ æ¥ç€ï¼Œè®©æˆ‘ä»¬çš„åˆçº¦ç»§æ‰¿å®ƒï¼Œç„¶åæˆ‘ä»¬ç”¨ä¸€ä¸ªå‡½æ•°å®šä¹‰æ¥é‡å†™æ¯ä¸ªæ–¹æ³•ã€‚

ä½†ç­‰ä¸€ä¸‹â€”â€” `ZombieOwnership`å·²ç»ç»§æ‰¿è‡ª `ZombieAttack`äº† â€”â€” å®ƒå¦‚ä½•èƒ½å¤Ÿä¹Ÿç»§æ‰¿äº `ERC721`å‘¢ï¼Ÿ

å¹¸è¿çš„æ˜¯åœ¨Solidityï¼Œä½ çš„åˆçº¦å¯ä»¥**ç»§æ‰¿è‡ªå¤šä¸ªåˆçº¦**ï¼Œå‚è€ƒå¦‚ä¸‹ï¼š

```
contract SatoshiNakamoto is NickSzabo, HalFinney {
  // å•§å•§å•§ï¼Œå®‡å®™çš„å¥¥ç§˜æ³„éœ²äº†
}
```

æ­£å¦‚ä½ æ‰€è§ï¼Œå½“ä½¿ç”¨å¤šé‡ç»§æ‰¿çš„æ—¶å€™ï¼Œä½ åªéœ€è¦ç”¨é€—å· `,` æ¥éš”å¼€å‡ ä¸ªä½ æƒ³è¦ç»§æ‰¿çš„åˆçº¦ã€‚åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬çš„åˆçº¦ç»§æ‰¿è‡ª `NickSzabo` å’Œ `HalFinney`ã€‚

æ¥è¯•è¯•å§ã€‚

### å®æˆ˜æ¼”ä¹ 

æˆ‘ä»¬å·²ç»åœ¨ä¸Šé¢ä¸ºä½ åˆ›å»ºäº†å¸¦ç€æ¥å£çš„ `erc721.sol` ã€‚

1. å°† `erc721.sol` å¯¼å…¥åˆ° `zombieownership.sol`
2. å£°æ˜ `ZombieOwnership` ç»§æ‰¿è‡ª `ZombieAttack` å’Œ `ERC721`

```solidity
pragma solidity ^0.4.19;

import "./zombieattack.sol";
// åœ¨è¿™é‡Œå¼•å…¥æ–‡ä»¶
import "./erc721.sol";

// åœ¨è¿™é‡Œå£°æ˜ ERC721 çš„ç»§æ‰¿
contract ZombieOwnership is ZombieAttack, ERC721 {

}

```

## ç¬¬3ç« : balanceOf å’Œ ownerOf

å¤ªæ£’äº†ï¼Œæˆ‘ä»¬æ¥æ·±å…¥è®¨è®ºä¸€ä¸‹ ERC721 çš„å®ç°ã€‚

æˆ‘ä»¬å·²ç»æŠŠæ‰€æœ‰ä½ éœ€è¦åœ¨æœ¬è¯¾ä¸­å®ç°çš„å‡½æ•°çš„ç©ºå£³å¤åˆ¶å¥½äº†ã€‚

åœ¨æœ¬ç« èŠ‚ï¼Œæˆ‘ä»¬å°†å®ç°å¤´ä¸¤ä¸ªæ–¹æ³•ï¼š `balanceOf` å’Œ `ownerOf`ã€‚

### `balanceOf`

```
  function balanceOf(address _owner) public view returns (uint256 _balance);
```

è¿™ä¸ªå‡½æ•°åªéœ€è¦ä¸€ä¸ªä¼ å…¥ `address` å‚æ•°ï¼Œç„¶åè¿”å›è¿™ä¸ª `address` æ‹¥æœ‰å¤šå°‘ä»£å¸ã€‚

åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬çš„â€œä»£å¸â€æ˜¯åƒµå°¸ã€‚ä½ è¿˜è®°å¾—åœ¨æˆ‘ä»¬ DApp çš„å“ªé‡Œå­˜å‚¨äº†ä¸€ä¸ªä¸»äººæ‹¥æœ‰å¤šå°‘åªåƒµå°¸å—ï¼Ÿ

### `ownerOf`

```
  function ownerOf(uint256 _tokenId) public view returns (address _owner);
```

è¿™ä¸ªå‡½æ•°éœ€è¦ä¼ å…¥ä¸€ä¸ªä»£å¸ ID ä½œä¸ºå‚æ•° (æˆ‘ä»¬çš„æƒ…å†µå°±æ˜¯ä¸€ä¸ªåƒµå°¸ ID)ï¼Œç„¶åè¿”å›è¯¥ä»£å¸æ‹¥æœ‰è€…çš„ `address`ã€‚

åŒæ ·çš„ï¼Œå› ä¸ºåœ¨æˆ‘ä»¬çš„ DApp é‡Œå·²ç»æœ‰ä¸€ä¸ª `mapping` (æ˜ å°„) å­˜å‚¨äº†è¿™ä¸ªä¿¡æ¯ï¼Œæ‰€ä»¥å¯¹æˆ‘ä»¬æ¥è¯´è¿™ä¸ªå®ç°éå¸¸ç›´æ¥æ¸…æ™°ã€‚æˆ‘ä»¬å¯ä»¥åªç”¨ä¸€è¡Œ `return` è¯­å¥æ¥å®ç°è¿™ä¸ªå‡½æ•°ã€‚

> æ³¨æ„ï¼šè¦è®°å¾—ï¼Œ `uint256` ç­‰åŒäº`uint`ã€‚æˆ‘ä»¬ä»è¯¾ç¨‹çš„å¼€å§‹ä¸€ç›´åœ¨ä»£ç ä¸­ä½¿ç”¨ `uint`ï¼Œä½†ä»ç°åœ¨å¼€å§‹æˆ‘ä»¬å°†åœ¨è¿™é‡Œç”¨ `uint256`ï¼Œå› ä¸ºæˆ‘ä»¬ç›´æ¥ä»è§„èŒƒä¸­å¤åˆ¶ç²˜è´´ã€‚

### å®æˆ˜æ¼”ä¹ 

æˆ‘å°†è®©ä½ æ¥å†³å®šå¦‚ä½•å®ç°è¿™ä¸¤ä¸ªå‡½æ•°ã€‚

æ¯ä¸ªå‡½æ•°çš„ä»£ç éƒ½åº”è¯¥åªæœ‰1è¡Œ `return` è¯­å¥ã€‚çœ‹çœ‹æˆ‘ä»¬åœ¨ä¹‹å‰è¯¾ç¨‹ä¸­å†™çš„ä»£ç ï¼Œæƒ³æƒ³æˆ‘ä»¬éƒ½æŠŠè¿™ä¸ªæ•°æ®å­˜å‚¨åœ¨å“ªã€‚å¦‚æœä½ è§‰å¾—æœ‰å›°éš¾ï¼Œä½ å¯ä»¥ç‚¹â€œæˆ‘è¦çœ‹ç­”æ¡ˆâ€çš„æŒ‰é’®æ¥è·å¾—å¸®åŠ©ã€‚

1. å®ç° `balanceOf` æ¥è¿”å› `_owner` æ‹¥æœ‰çš„åƒµå°¸æ•°é‡ã€‚
2. å®ç° `ownerOf` æ¥è¿”å›æ‹¥æœ‰ ID ä¸º `_tokenId` åƒµå°¸çš„æ‰€æœ‰è€…çš„åœ°å€ã€‚

```solidity
pragma solidity ^0.4.19;

import "./zombieattack.sol";
import "./erc721.sol";

contract ZombieOwnership is ZombieAttack, ERC721 {

  function balanceOf(address _owner) public view returns (uint256 _balance) {
    // 1. åœ¨è¿™é‡Œè¿”å› `_owner` æ‹¥æœ‰çš„åƒµå°¸æ•°
    return ownerZombieCount[_owner];

  }

  function ownerOf(uint256 _tokenId) public view returns (address _owner) {
    // 2. åœ¨è¿™é‡Œè¿”å› `_tokenId` çš„æ‰€æœ‰è€…
    return zombieToOwner[_tokenId];
  }

  function transfer(address _to, uint256 _tokenId) public {

  }

  function approve(address _to, uint256 _tokenId) public {

  }

  function takeOwnership(uint256 _tokenId) public {

  }
}

```

## ç¬¬4ç« : é‡æ„

å˜¿å˜¿ï¼æˆ‘ä»¬åˆšåˆšçš„ä»£ç ä¸­å…¶å®æœ‰ä¸ªé”™è¯¯ï¼Œä»¥è‡³äºå…¶æ ¹æœ¬æ— æ³•é€šè¿‡ç¼–è¯‘ï¼Œä½ å‘ç°äº†æ²¡ï¼Ÿ

åœ¨å‰ä¸€ä¸ªç« èŠ‚æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªå« `ownerOf` çš„å‡½æ•°ã€‚ä½†å¦‚æœä½ è¿˜è®°å¾—ç¬¬4è¯¾çš„å†…å®¹ï¼Œæˆ‘ä»¬åŒæ ·åœ¨`zombiefeeding.sol` é‡Œä»¥ `ownerOf` å‘½ååˆ›å»ºäº†ä¸€ä¸ª `modifier`ï¼ˆä¿®é¥°ç¬¦ï¼‰ã€‚

å¦‚æœä½ å°è¯•ç¼–è¯‘è¿™æ®µä»£ç ï¼Œç¼–è¯‘å™¨ä¼šç»™ä½ ä¸€ä¸ªé”™è¯¯è¯´ä½ ä¸èƒ½æœ‰ç›¸åŒåç§°çš„ä¿®é¥°ç¬¦å’Œå‡½æ•°ã€‚

æ‰€ä»¥æˆ‘ä»¬åº”è¯¥æŠŠåœ¨ `ZombieOwnership` é‡Œçš„å‡½æ•°åç§°æ”¹æˆåˆ«çš„å—ï¼Ÿ

ä¸ï¼Œæˆ‘ä»¬ä¸èƒ½é‚£æ ·åšï¼ï¼ï¼è¦è®°å¾—ï¼Œæˆ‘ä»¬æ­£åœ¨ç”¨ ERC721 ä»£å¸æ ‡å‡†ï¼Œæ„å‘³ç€å…¶ä»–åˆçº¦å°†æœŸæœ›æˆ‘ä»¬çš„åˆçº¦ä»¥è¿™äº›ç¡®åˆ‡çš„åç§°æ¥å®šä¹‰å‡½æ•°ã€‚è¿™å°±æ˜¯è¿™äº›æ ‡å‡†å®ç”¨çš„åŸå› â€”â€”å¦‚æœå¦ä¸€ä¸ªåˆçº¦çŸ¥é“æˆ‘ä»¬çš„åˆçº¦ç¬¦åˆ ERC721 æ ‡å‡†ï¼Œå®ƒå¯ä»¥ç›´æ¥ä¸æˆ‘ä»¬äº¤äº’ï¼Œè€Œæ— éœ€äº†è§£ä»»ä½•å…³äºæˆ‘ä»¬å†…éƒ¨å¦‚ä½•å®ç°çš„ç»†èŠ‚ã€‚

æ‰€ä»¥ï¼Œé‚£æ„å‘³ç€æˆ‘ä»¬å°†å¿…é¡»é‡æ„æˆ‘ä»¬ç¬¬4è¯¾ä¸­çš„ä»£ç ï¼Œå°† `modifier` çš„åç§°æ¢æˆåˆ«çš„ã€‚

### å®æˆ˜æ¼”ä¹ 

æˆ‘ä»¬å›åˆ°äº† `zombiefeeding.sol` ã€‚æˆ‘ä»¬å°†æŠŠ `modifier` çš„åç§°ä» `ownerOf` æ”¹æˆ `onlyOwnerOf`ã€‚

1. æŠŠä¿®é¥°ç¬¦å®šä¹‰ä¸­çš„åç§°æ”¹æˆ `onlyOwnerOf`
2. å¾€ä¸‹æ»‘åˆ°ä½¿ç”¨æ­¤ä¿®é¥°ç¬¦çš„å‡½æ•° `feedAndMultiply` ã€‚æˆ‘ä»¬ä¹Ÿéœ€è¦æ”¹è¿™é‡Œçš„åç§°ã€‚

> æ³¨æ„ï¼šæˆ‘ä»¬åœ¨ `zombiehelper.sol` å’Œ `zombieattack.sol` é‡Œä¹Ÿä½¿ç”¨äº†è¿™ä¸ªä¿®é¥°ç¬¦ï¼Œä½†ä¸ºäº†ä¸åœ¨è¿™èŠ‚è¯¾çš„é‡æ„é‡ŒèŠ±å¤ªå¤šæ—¶é—´ï¼Œæˆ‘ä»¬å·²ç»å°†é‚£äº›æ–‡ä»¶é‡Œçš„ä¿®é¥°ç¬¦åç§°ä¸ºä½ æ”¹å¥½äº†ã€‚

```solidity
pragma solidity ^0.4.19;

import "./zombiefactory.sol";

contract KittyInterface {
  function getKitty(uint256 _id) external view returns (
    bool isGestating,
    bool isReady,
    uint256 cooldownIndex,
    uint256 nextActionAt,
    uint256 siringWithId,
    uint256 birthTime,
    uint256 matronId,
    uint256 sireId,
    uint256 generation,
    uint256 genes
  );
}

contract ZombieFeeding is ZombieFactory {

  KittyInterface kittyContract;

  // 1. æŠŠä¿®é¥°ç¬¦åç§°æ”¹æˆ `onlyOwnerOf`
  modifier onlyOwnerOf(uint _zombieId) {
    require(msg.sender == zombieToOwner[_zombieId]);
    _;
  }

  function setKittyContractAddress(address _address) external onlyOwner {
    kittyContract = KittyInterface(_address);
  }

  function _triggerCooldown(Zombie storage _zombie) internal {
    _zombie.readyTime = uint32(now + cooldownTime);
  }

  function _isReady(Zombie storage _zombie) internal view returns (bool) {
      return (_zombie.readyTime <= now);
  }

  // 2. è¿™é‡Œä¹Ÿè¦ä¿®æ”¹ä¿®é¥°ç¬¦çš„åç§°
  function feedAndMultiply(uint _zombieId, uint _targetDna, string _species) internal onlyOwnerOf(_zombieId) {
    Zombie storage myZombie = zombies[_zombieId];
    require(_isReady(myZombie));
    _targetDna = _targetDna % dnaModulus;
    uint newDna = (myZombie.dna + _targetDna) / 2;
    if (keccak256(_species) == keccak256("kitty")) {
      newDna = newDna - newDna % 100 + 99;
    }
    _createZombie("NoName", newDna);
    _triggerCooldown(myZombie);
  }

  function feedOnKitty(uint _zombieId, uint _kittyId) public {
    uint kittyDna;
    (,,,,,,,,,kittyDna) = kittyContract.getKitty(_kittyId);
    feedAndMultiply(_zombieId, kittyDna, "kitty");
  }
}

```

## ç¬¬5ç« : ERC721: è½¬ç§»æ ‡å‡†

å¥½äº†ï¼Œæˆ‘ä»¬å°†å†²çªä¿®å¤äº†ï¼

ç°åœ¨æˆ‘ä»¬å°†é€šè¿‡å­¦ä¹ æŠŠæ‰€æœ‰æƒä»ä¸€ä¸ªäººè½¬ç§»ç»™å¦ä¸€ä¸ªäººæ¥ç»§ç»­æˆ‘ä»¬çš„ ERC721 è§„èŒƒçš„å®ç°ã€‚

æ³¨æ„ ERC721 è§„èŒƒæœ‰ä¸¤ç§ä¸åŒçš„æ–¹æ³•æ¥è½¬ç§»ä»£å¸ï¼š

```
function transfer(address _to, uint256 _tokenId) public;

function approve(address _to, uint256 _tokenId) public;
function takeOwnership(uint256 _tokenId) public;
```

1. ç¬¬ä¸€ç§æ–¹æ³•æ˜¯ä»£å¸çš„æ‹¥æœ‰è€…è°ƒç”¨`transfer` æ–¹æ³•ï¼Œä¼ å…¥ä»–æƒ³è½¬ç§»åˆ°çš„ `address` å’Œä»–æƒ³è½¬ç§»çš„ä»£å¸çš„ `_tokenId`ã€‚
2. ç¬¬äºŒç§æ–¹æ³•æ˜¯ä»£å¸æ‹¥æœ‰è€…é¦–å…ˆè°ƒç”¨ `approve`ï¼Œç„¶åä¼ å…¥ä¸ä»¥ä¸Šç›¸åŒçš„å‚æ•°ã€‚æ¥ç€ï¼Œè¯¥åˆçº¦ä¼šå­˜å‚¨è°è¢«å…è®¸æå–ä»£å¸ï¼Œé€šå¸¸å­˜å‚¨åˆ°ä¸€ä¸ª `mapping (uint256 => address)` é‡Œã€‚ç„¶åï¼Œå½“æœ‰äººè°ƒç”¨ `takeOwnership` æ—¶ï¼Œåˆçº¦ä¼šæ£€æŸ¥ `msg.sender` æ˜¯å¦å¾—åˆ°æ‹¥æœ‰è€…çš„æ‰¹å‡†æ¥æå–ä»£å¸ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™å°†ä»£å¸è½¬ç§»ç»™ä»–ã€‚

ä½ æ³¨æ„åˆ°äº†å—ï¼Œ`transfer` å’Œ `takeOwnership` éƒ½å°†åŒ…å«ç›¸åŒçš„è½¬ç§»é€»è¾‘ï¼Œåªæ˜¯ä»¥ç›¸åçš„é¡ºåºã€‚ ï¼ˆä¸€ç§æƒ…å†µæ˜¯ä»£å¸çš„å‘é€è€…è°ƒç”¨å‡½æ•°ï¼›å¦ä¸€ç§æƒ…å†µæ˜¯ä»£å¸çš„æ¥æ”¶è€…è°ƒç”¨å®ƒï¼‰ã€‚

æ‰€ä»¥æˆ‘ä»¬æŠŠè¿™ä¸ªé€»è¾‘æŠ½è±¡æˆå®ƒè‡ªå·±çš„ç§æœ‰å‡½æ•° `_transfer`ï¼Œç„¶åç”±è¿™ä¸¤ä¸ªå‡½æ•°æ¥è°ƒç”¨å®ƒã€‚ è¿™æ ·æˆ‘ä»¬å°±ä¸ç”¨å†™é‡å¤çš„ä»£ç äº†ã€‚

### å®æˆ˜æ¼”ä¹ 

è®©æˆ‘ä»¬æ¥å®šä¹‰ `_transfer` çš„é€»è¾‘ã€‚

1. å®šä¹‰ä¸€ä¸ªåä¸º `_transfer`çš„å‡½æ•°ã€‚å®ƒä¼šéœ€è¦3ä¸ªå‚æ•°ï¼š`address _from`ã€`address _to`å’Œ`uint256 _tokenId`ã€‚å®ƒåº”è¯¥æ˜¯ä¸€ä¸ª `ç§æœ‰` å‡½æ•°ã€‚

2. æˆ‘ä»¬æœ‰2ä¸ªæ˜ å°„ä¼šåœ¨æ‰€æœ‰æƒæ”¹å˜çš„æ—¶å€™æ”¹å˜ï¼š `ownerZombieCount` ï¼ˆè®°å½•ä¸€ä¸ªæ‰€æœ‰è€…æœ‰å¤šå°‘åªåƒµå°¸ï¼‰å’Œ `zombieToOwner` ï¼ˆè®°å½•ä»€ä¹ˆäººæ‹¥æœ‰ä»€ä¹ˆï¼‰ã€‚

   æˆ‘ä»¬çš„å‡½æ•°éœ€è¦åšçš„ç¬¬ä¸€ä»¶äº‹æ˜¯ä¸º **æ¥æ”¶** åƒµå°¸çš„äººï¼ˆ`address _to`ï¼‰å¢ åŠ `ownerZombieCount`ã€‚ä½¿ç”¨ `++` æ¥å¢åŠ ã€‚

3. æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†éœ€è¦ä¸º **å‘é€** åƒµå°¸çš„äººï¼ˆ`address _from`ï¼‰**å‡å°‘**`ownerZombieCount`ã€‚ä½¿ç”¨ `--` æ¥æ‰£å‡ã€‚

4. æœ€åï¼Œæˆ‘ä»¬å°†æ”¹å˜è¿™ä¸ª `_tokenId` çš„ `zombieToOwner` æ˜ å°„ï¼Œè¿™æ ·å®ƒç°åœ¨å°±ä¼šæŒ‡å‘ `_to`ã€‚

5. éª—ä½ çš„ï¼Œé‚£ä¸æ˜¯æœ€åä¸€æ­¥ã€‚æˆ‘ä»¬è¿˜éœ€è¦å†åšä¸€ä»¶äº‹æƒ…ã€‚

   ERC721è§„èŒƒåŒ…å«äº†ä¸€ä¸ª `Transfer` äº‹ä»¶ã€‚è¿™ä¸ªå‡½æ•°çš„æœ€åä¸€è¡Œåº”è¯¥ç”¨æ­£ç¡®çš„å‚æ•°è§¦å‘`Transfer` â€”â€”æŸ¥çœ‹ `erc721.sol` çœ‹å®ƒæœŸæœ›ä¼ å…¥çš„å‚æ•°å¹¶åœ¨è¿™é‡Œå®ç°ã€‚

```solidity
pragma solidity ^0.4.19;

import "./zombieattack.sol";
import "./erc721.sol";

contract ZombieOwnership is ZombieAttack, ERC721 {

  function balanceOf(address _owner) public view returns (uint256 _balance) {
    return ownerZombieCount[_owner];
  }

  function ownerOf(uint256 _tokenId) public view returns (address _owner) {
    return zombieToOwner[_tokenId];
  }

  // åœ¨è¿™é‡Œå®šä¹‰ _transfer()
  function _transfer(address _from, address _to, uint256 _tokenId) private {
      ownerZombieCount[_to]++;
      ownerZombieCount[_from]--;
      zombieToOwner[_tokenId] = _to;
      Transfer(_from, _to, _tokenId);
  }

  function transfer(address _to, uint256 _tokenId) public {

  }

  function approve(address _to, uint256 _tokenId) public {

  }

  function takeOwnership(uint256 _tokenId) public {

  }
}

```

## ç¬¬6ç« : ERC721: è½¬ç§»-ç»­

å¤ªå¥½äº†ï¼åˆšæ‰é‚£æ˜¯æœ€éš¾çš„éƒ¨åˆ†â€”â€”ç°åœ¨å®ç°å…¬å…±çš„ `transfer` å‡½æ•°åº”è¯¥ååˆ†å®¹æ˜“ï¼Œå› ä¸ºæˆ‘ä»¬çš„ `_transfer` å‡½æ•°å‡ ä¹å·²ç»æŠŠæ‰€æœ‰çš„é‡æ´»éƒ½å¹²å®Œäº†ã€‚

### å®æˆ˜æ¼”ä¹ 

1. æˆ‘ä»¬æƒ³ç¡®ä¿åªæœ‰ä»£å¸æˆ–åƒµå°¸çš„æ‰€æœ‰è€…å¯ä»¥è½¬ç§»å®ƒã€‚è¿˜è®°å¾—æˆ‘ä»¬å¦‚ä½•é™åˆ¶åªæœ‰æ‰€æœ‰è€…æ‰èƒ½è®¿é—®æŸä¸ªåŠŸèƒ½å—ï¼Ÿ

   æ²¡é”™ï¼Œæˆ‘ä»¬å·²ç»æœ‰ä¸€ä¸ªä¿®é¥°ç¬¦èƒ½å¤Ÿå®Œæˆè¿™ä¸ªä»»åŠ¡äº†ã€‚æ‰€ä»¥å°†ä¿®é¥°ç¬¦ `onlyOwnerOf` æ·»åŠ åˆ°è¿™ä¸ªå‡½æ•°ä¸­ã€‚

2. ç°åœ¨è¯¥å‡½æ•°çš„æ­£æ–‡åªéœ€è¦ä¸€è¡Œä»£ç ã€‚å®ƒåªéœ€è¦è°ƒç”¨ `_transfer`ã€‚

   è®°å¾—æŠŠ `msg.sender` ä½œä¸ºå‚æ•°ä¼ é€’è¿› `address _from`ã€‚

```solidity
pragma solidity ^0.4.19;

import "./zombieattack.sol";
import "./erc721.sol";

contract ZombieOwnership is ZombieAttack, ERC721 {

  function balanceOf(address _owner) public view returns (uint256 _balance) {
    return ownerZombieCount[_owner];
  }

  function ownerOf(uint256 _tokenId) public view returns (address _owner) {
    return zombieToOwner[_tokenId];
  }

  function _transfer(address _from, address _to, uint256 _tokenId) private {
    ownerZombieCount[_to]++;
    ownerZombieCount[_from]--;
    zombieToOwner[_tokenId] = _to;
    Transfer(_from, _to, _tokenId);
  }

  // 1. åœ¨è¿™é‡Œæ·»åŠ ä¿®é¥°ç¬¦
  function transfer(address _to, uint256 _tokenId) public onlyOwnerOf(_tokenId) {
    // 2. åœ¨è¿™é‡Œå®šä¹‰æ–¹æ³•
    _transfer(msg.sender, _to, _tokenId);
  }

  function approve(address _to, uint256 _tokenId) public {

  }

  function takeOwnership(uint256 _tokenId) public {

  }
}

```

## ç¬¬7ç« : ERC721: æ‰¹å‡†

ç°åœ¨ï¼Œè®©æˆ‘ä»¬æ¥å®ç° `approve`ã€‚

è®°ä½ï¼Œä½¿ç”¨ `approve` æˆ–è€… `takeOwnership` çš„æ—¶å€™ï¼Œè½¬ç§»æœ‰2ä¸ªæ­¥éª¤ï¼š

1. ä½ ï¼Œä½œä¸ºæ‰€æœ‰è€…ï¼Œç”¨æ–°ä¸»äººçš„ `address` å’Œä½ å¸Œæœ›ä»–è·å–çš„ `_tokenId` æ¥è°ƒç”¨ `approve`
2. æ–°ä¸»äººç”¨ `_tokenId` æ¥è°ƒç”¨ `takeOwnership`ï¼Œåˆçº¦ä¼šæ£€æŸ¥ç¡®ä¿ä»–è·å¾—äº†æ‰¹å‡†ï¼Œç„¶åæŠŠä»£å¸è½¬ç§»ç»™ä»–ã€‚

å› ä¸ºè¿™å‘ç”Ÿåœ¨2ä¸ªå‡½æ•°çš„è°ƒç”¨ä¸­ï¼Œæ‰€ä»¥åœ¨å‡½æ•°è°ƒç”¨ä¹‹é—´ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ•°æ®ç»“æ„æ¥å­˜å‚¨ä»€ä¹ˆäººè¢«æ‰¹å‡†è·å–ä»€ä¹ˆã€‚

### å®æˆ˜æ¼”ä¹ 

1. é¦–å…ˆï¼Œè®©æˆ‘ä»¬æ¥å®šä¹‰ä¸€ä¸ªæ˜ å°„ `zombieApprovals`ã€‚å®ƒåº”è¯¥å°†ä¸€ä¸ª `uint` æ˜ å°„åˆ°ä¸€ä¸ª `address`ã€‚

   è¿™æ ·ä¸€æ¥ï¼Œå½“æœ‰äººç”¨ä¸€ä¸ª `_tokenId` è°ƒç”¨ `takeOwnership` æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨è¿™ä¸ªæ˜ å°„æ¥å¿«é€ŸæŸ¥æ‰¾è°è¢«æ‰¹å‡†è·å–é‚£ä¸ªä»£å¸ã€‚

2. åœ¨å‡½æ•° `approve` ä¸Šï¼Œ æˆ‘ä»¬æƒ³è¦ç¡®ä¿åªæœ‰ä»£å¸æ‰€æœ‰è€…å¯ä»¥æ‰¹å‡†æŸäººæ¥è·å–ä»£å¸ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦æ·»åŠ ä¿®é¥°ç¬¦ `onlyOwnerOf` åˆ° `approve`ã€‚

3. å‡½æ•°çš„æ­£æ–‡éƒ¨åˆ†ï¼Œå°† `_tokenId` çš„ `zombieApprovals` è®¾ç½®ä¸ºå’Œ `_to` ç›¸ç­‰ã€‚

4. æœ€åï¼Œåœ¨ ERC721 è§„èŒƒé‡Œæœ‰ä¸€ä¸ª `Approval` äº‹ä»¶ã€‚æ‰€ä»¥æˆ‘ä»¬åº”è¯¥åœ¨è¿™ä¸ªå‡½æ•°çš„æœ€åè§¦å‘è¿™ä¸ªäº‹ä»¶ã€‚ï¼ˆå‚è€ƒ `erc721.sol` æ¥ç¡®è®¤ä¼ å…¥çš„å‚æ•°ï¼Œå¹¶ç¡®ä¿ `_owner` æ˜¯ `msg.sender`ï¼‰

```solidity
pragma solidity ^0.4.19;

import "./zombieattack.sol";
import "./erc721.sol";

contract ZombieOwnership is ZombieAttack, ERC721 {

  // 1. åœ¨è¿™é‡Œå®šä¹‰æ˜ å°„
  mapping(uint => address) zombieApprovals;

  function balanceOf(address _owner) public view returns (uint256 _balance) {
    return ownerZombieCount[_owner];
  }

  function ownerOf(uint256 _tokenId) public view returns (address _owner) {
    return zombieToOwner[_tokenId];
  }

  function _transfer(address _from, address _to, uint256 _tokenId) private {
    ownerZombieCount[_to]++;
    ownerZombieCount[_from]--;
    zombieToOwner[_tokenId] = _to;
    Transfer(_from, _to, _tokenId);
  }

  function transfer(address _to, uint256 _tokenId) public onlyOwnerOf(_tokenId) {
    _transfer(msg.sender, _to, _tokenId);
  }

  // 2. åœ¨è¿™é‡Œæ·»åŠ æ–¹æ³•ä¿®é¥°ç¬¦
  function approve(address _to, uint256 _tokenId) public onlyOwnerOf(_tokenId) {
    // 3. åœ¨è¿™é‡Œå®šä¹‰æ–¹æ³•
    zombieApprovals[_tokenId] = _to;
    Approval(msg.sender, _to, _tokenId);
  }

  function takeOwnership(uint256 _tokenId) public {

  }
}

```

## ç¬¬8ç« : ERC721: takeOwnership

å¤ªæ£’äº†ï¼Œç°åœ¨è®©æˆ‘ä»¬å®Œæˆæœ€åä¸€ä¸ªå‡½æ•°æ¥ç»“æŸ ERC721 çš„å®ç°ã€‚ï¼ˆåˆ«æ‹…å¿ƒï¼Œè¿™åé¢æˆ‘ä»¬è¿˜ä¼šè®²æ›´å¤šå†…å®¹ğŸ˜‰ï¼‰

æœ€åä¸€ä¸ªå‡½æ•° `takeOwnership`ï¼Œ åº”è¯¥åªæ˜¯ç®€å•åœ°æ£€æŸ¥ä»¥ç¡®ä¿ `msg.sender` å·²ç»è¢«æ‰¹å‡†æ¥æå–è¿™ä¸ªä»£å¸æˆ–è€…åƒµå°¸ã€‚è‹¥ç¡®è®¤ï¼Œå°±è°ƒç”¨ `_transfer`ï¼›

### å®æˆ˜æ¼”ä¹ 

1. é¦–å…ˆï¼Œæˆ‘ä»¬è¦ç”¨ä¸€ä¸ª `require` å¥å¼æ¥æ£€æŸ¥ `_tokenId` çš„ `zombieApprovals`å’Œ `msg.sender` ç›¸ç­‰ã€‚

   è¿™æ ·å¦‚æœ `msg.sender` æœªè¢«æˆæƒæ¥æå–è¿™ä¸ªä»£å¸ï¼Œå°†æŠ›å‡ºä¸€ä¸ªé”™è¯¯ã€‚

2. ä¸ºäº†è°ƒç”¨ `_transfer`ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“ä»£å¸æ‰€æœ‰è€…çš„åœ°å€ï¼ˆå®ƒéœ€è¦ä¸€ä¸ª `_from`æ¥ä½œä¸ºå‚æ•°ï¼‰ã€‚å¹¸è¿çš„æ˜¯æˆ‘ä»¬å¯ä»¥åœ¨æˆ‘ä»¬çš„ `ownerOf` å‡½æ•°ä¸­æ¥æ‰¾åˆ°è¿™ä¸ªå‚æ•°ã€‚

   æ‰€ä»¥ï¼Œå®šä¹‰ä¸€ä¸ªåä¸º `owner` çš„ `address` å˜é‡ï¼Œå¹¶ä½¿å…¶ç­‰äº `ownerOf(_tokenId)`ã€‚

3. æœ€åï¼Œè°ƒç”¨ `_transfer`, å¹¶ä¼ å…¥æ‰€æœ‰å¿…é¡»çš„å‚æ•°ã€‚ï¼ˆåœ¨è¿™é‡Œä½ å¯ä»¥ç”¨ `msg.sender` ä½œä¸º `_to`ï¼Œ å› ä¸ºä»£å¸æ­£æ˜¯è¦å‘é€ç»™è°ƒç”¨è¿™ä¸ªå‡½æ•°çš„äººï¼‰ã€‚

   > æ³¨æ„ï¼š æˆ‘ä»¬å®Œå…¨å¯ä»¥ç”¨ä¸€è¡Œä»£ç æ¥å®ç°ç¬¬2ã€3ä¸¤æ­¥ã€‚ä½†æ˜¯åˆ†å¼€å†™ä¼šè®©ä»£ç æ›´æ˜“è¯»ã€‚ä¸€ç‚¹ä¸ªäººå»ºè®® :)

```solidity
pragma solidity ^0.4.19;

import "./zombieattack.sol";
import "./erc721.sol";

contract ZombieOwnership is ZombieAttack, ERC721 {

  mapping (uint => address) zombieApprovals;

  function balanceOf(address _owner) public view returns (uint256 _balance) {
    return ownerZombieCount[_owner];
  }

  function ownerOf(uint256 _tokenId) public view returns (address _owner) {
    return zombieToOwner[_tokenId];
  }

  function _transfer(address _from, address _to, uint256 _tokenId) private {
    ownerZombieCount[_to]++;
    ownerZombieCount[_from]--;
    zombieToOwner[_tokenId] = _to;
    Transfer(_from, _to, _tokenId);
  }

  function transfer(address _to, uint256 _tokenId) public onlyOwnerOf(_tokenId) {
    _transfer(msg.sender, _to, _tokenId);
  }

  function approve(address _to, uint256 _tokenId) public onlyOwnerOf(_tokenId) {
    zombieApprovals[_tokenId] = _to;
    Approval(msg.sender, _to, _tokenId);
  }

  function takeOwnership(uint256 _tokenId) public {
    // ä»è¿™é‡Œå¼€å§‹
    require(zombieApprovals[_tokenId] == msg.sender);
    address owner = ownerOf(_tokenId);
    _transfer(owner, msg.sender, _tokenId);
  }
}

```

## ç¬¬9ç« : é¢„é˜²æº¢å‡º

æ­å–œä½ ï¼Œæˆ‘ä»¬å®Œæˆäº† ERC721 çš„å®ç°ã€‚

å¹¶ä¸æ˜¯å¾ˆå¤æ‚ï¼Œå¯¹å§ï¼Ÿå¾ˆå¤šç±»ä¼¼çš„ä»¥å¤ªåŠæ¦‚å¿µï¼Œå½“ä½ åªå¬äººä»¬è°ˆè®ºå®ƒä»¬çš„æ—¶å€™ï¼Œä¼šè§‰å¾—å¾ˆå¤æ‚ã€‚æ‰€ä»¥æœ€ç®€å•çš„ç†è§£æ–¹å¼å°±æ˜¯ä½ è‡ªå·±æ¥å®ç°å®ƒã€‚

ä¸è¿‡è¦è®°ä½é‚£åªæ˜¯æœ€ç®€å•çš„å®ç°ã€‚è¿˜æœ‰å¾ˆå¤šçš„ç‰¹æ€§æˆ‘ä»¬ä¹Ÿè®¸æƒ³åŠ å…¥åˆ°æˆ‘ä»¬çš„å®ç°ä¸­æ¥ï¼Œæ¯”å¦‚ä¸€äº›é¢å¤–çš„æ£€æŸ¥ï¼Œæ¥ç¡®ä¿ç”¨æˆ·ä¸ä¼šä¸å°å¿ƒæŠŠä»–ä»¬çš„åƒµå°¸è½¬ç§»ç»™`0` åœ°å€ï¼ˆè¿™è¢«ç§°ä½œ â€œçƒ§å¸â€, åŸºæœ¬ä¸Šå°±æ˜¯æŠŠä»£å¸è½¬ç§»åˆ°ä¸€ä¸ªè°ä¹Ÿæ²¡æœ‰ç§é’¥çš„åœ°å€ï¼Œè®©è¿™ä¸ªä»£å¸æ°¸è¿œä¹Ÿæ— æ³•æ¢å¤ï¼‰ã€‚ æˆ–è€…åœ¨ DApp ä¸­åŠ å…¥ä¸€äº›åŸºæœ¬çš„æ‹å–é€»è¾‘ã€‚ï¼ˆä½ èƒ½æƒ³å‡ºä¸€äº›å®ç°çš„æ–¹æ³•ä¹ˆï¼Ÿï¼‰

ä½†æ˜¯ä¸ºäº†è®©æˆ‘ä»¬çš„è¯¾ç¨‹ä¸è‡³äºç¦»é¢˜å¤ªè¿œï¼Œæ‰€ä»¥æˆ‘ä»¬åªä¸“æ³¨äºä¸€äº›åŸºç¡€å®ç°ã€‚å¦‚æœä½ æƒ³å­¦ä¹ ä¸€äº›æ›´æ·±å±‚æ¬¡çš„å®ç°ï¼Œå¯ä»¥åœ¨è¿™ä¸ªæ•™ç¨‹ç»“æŸåï¼Œå»çœ‹çœ‹ OpenZeppelin çš„ ERC721 åˆçº¦ã€‚

### åˆçº¦å®‰å…¨å¢å¼º: æº¢å‡ºå’Œä¸‹æº¢

æˆ‘ä»¬å°†æ¥å­¦ä¹ ä½ åœ¨ç¼–å†™æ™ºèƒ½åˆçº¦çš„æ—¶å€™éœ€è¦æ³¨æ„çš„ä¸€ä¸ªä¸»è¦çš„å®‰å…¨ç‰¹æ€§ï¼šé˜²æ­¢æº¢å‡ºå’Œä¸‹æº¢ã€‚

ä»€ä¹ˆæ˜¯ **æº¢å‡º** (**overflow**)?

å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ª `uint8`, åªèƒ½å­˜å‚¨8 bitæ•°æ®ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬èƒ½å­˜å‚¨çš„æœ€å¤§æ•°å­—å°±æ˜¯äºŒè¿›åˆ¶ `11111111` (æˆ–è€…è¯´åè¿›åˆ¶çš„ 2^8 - 1 = 255).

æ¥çœ‹çœ‹ä¸‹é¢çš„ä»£ç ã€‚æœ€å `number` å°†ä¼šæ˜¯ä»€ä¹ˆå€¼ï¼Ÿ

```
uint8 number = 255;
number++;
```

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å¯¼è‡´äº†æº¢å‡º â€” è™½ç„¶æˆ‘ä»¬åŠ äº†1ï¼Œ ä½†æ˜¯ `number` å‡ºä¹æ„æ–™åœ°ç­‰äº `0`äº†ã€‚ (å¦‚æœä½ ç»™äºŒè¿›åˆ¶ `11111111` åŠ 1, å®ƒå°†è¢«é‡ç½®ä¸º `00000000`ï¼Œå°±åƒé’Ÿè¡¨ä» `23:59` èµ°å‘ `00:00`)ã€‚

ä¸‹æº¢(`underflow`)ä¹Ÿç±»ä¼¼ï¼Œå¦‚æœä½ ä»ä¸€ä¸ªç­‰äº `0` çš„ `uint8` å‡å» `1`, å®ƒå°†å˜æˆ `255` (å› ä¸º `uint` æ˜¯æ— ç¬¦å·çš„ï¼Œå…¶ä¸èƒ½ç­‰äºè´Ÿæ•°)ã€‚

è™½ç„¶æˆ‘ä»¬åœ¨è¿™é‡Œä¸ä½¿ç”¨ `uint8`ï¼Œè€Œä¸”æ¯æ¬¡ç»™ä¸€ä¸ª `uint256` åŠ  `1` ä¹Ÿä¸å¤ªå¯èƒ½æº¢å‡º (2^256 çœŸçš„æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„æ•°äº†)ï¼Œåœ¨æˆ‘ä»¬çš„åˆçº¦ä¸­æ·»åŠ ä¸€äº›ä¿æŠ¤æœºåˆ¶ä¾ç„¶æ˜¯éå¸¸æœ‰å¿…è¦çš„ï¼Œä»¥é˜²æˆ‘ä»¬çš„ DApp ä»¥åå‡ºç°ä»€ä¹ˆå¼‚å¸¸æƒ…å†µã€‚

### ä½¿ç”¨ SafeMath

ä¸ºäº†é˜²æ­¢è¿™äº›æƒ…å†µï¼ŒOpenZeppelin å»ºç«‹äº†ä¸€ä¸ªå«åš SafeMath çš„ **åº“**(**library**)ï¼Œé»˜è®¤æƒ…å†µä¸‹å¯ä»¥é˜²æ­¢è¿™äº›é—®é¢˜ã€‚

ä¸è¿‡åœ¨æˆ‘ä»¬ä½¿ç”¨ä¹‹å‰â€¦â€¦ ä»€ä¹ˆå«åšåº“?

ä¸€ä¸ª**åº“** æ˜¯ Solidity ä¸­ä¸€ç§ç‰¹æ®Šçš„åˆçº¦ã€‚å…¶ä¸­ä¸€ä¸ªæœ‰ç”¨çš„åŠŸèƒ½æ˜¯ç»™åŸå§‹æ•°æ®ç±»å‹å¢åŠ ä¸€äº›æ–¹æ³•ã€‚

æ¯”å¦‚ï¼Œä½¿ç”¨ SafeMath åº“çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ `using SafeMath for uint256` è¿™æ ·çš„è¯­æ³•ã€‚ SafeMath åº“æœ‰å››ä¸ªæ–¹æ³• â€” `add`ï¼Œ `sub`ï¼Œ `mul`ï¼Œ ä»¥åŠ `div`ã€‚ç°åœ¨æˆ‘ä»¬å¯ä»¥è¿™æ ·æ¥è®© `uint256` è°ƒç”¨è¿™äº›æ–¹æ³•ï¼š

```
using SafeMath for uint256;

uint256 a = 5;
uint256 b = a.add(3); // 5 + 3 = 8
uint256 c = a.mul(2); // 5 * 2 = 10
```

æˆ‘ä»¬å°†åœ¨ä¸‹ä¸€ç« æ¥å­¦ä¹ è¿™äº›æ–¹æ³•ï¼Œä¸è¿‡ç°åœ¨æˆ‘ä»¬å…ˆå°† SafeMath åº“æ·»åŠ è¿›æˆ‘ä»¬çš„åˆçº¦ã€‚

### å®æˆ˜æ¼”ä¹ 

æˆ‘ä»¬å·²ç»å¸®ä½ æŠŠ OpenZeppelin çš„ `SafeMath` åº“åŒ…å«è¿› `safemath.sol`äº†ï¼Œå¦‚æœä½ æƒ³çœ‹ä¸€ä¸‹ä»£ç çš„è¯ï¼Œç°åœ¨å¯ä»¥çœ‹çœ‹ï¼Œä¸è¿‡æˆ‘ä»¬ä¸‹ä¸€ç« å°†æ·±å…¥è¿›å»ã€‚

é¦–å…ˆæˆ‘ä»¬æ¥å‘Šè¯‰æˆ‘ä»¬çš„åˆçº¦è¦ä½¿ç”¨ SafeMathã€‚æˆ‘ä»¬å°†åœ¨æˆ‘ä»¬çš„ `ZombieFactory`é‡Œè°ƒç”¨ï¼Œè¿™æ˜¯æˆ‘ä»¬çš„åŸºç¡€åˆçº¦ â€” è¿™æ ·å…¶ä»–æ‰€æœ‰ç»§æ‰¿å‡ºå»çš„å­åˆçº¦éƒ½å¯ä»¥ä½¿ç”¨è¿™ä¸ªåº“äº†ã€‚

1. å°† `safemath.sol` å¼•å…¥åˆ° `zombiefactory.sol`.
2. æ·»åŠ å®šä¹‰ï¼š `using SafeMath for uint256;`.

zombiefactory.sol

```
pragma solidity ^0.4.19;

import "./ownable.sol";
// 1. åœ¨è¿™é‡Œå¼•å…¥
import "./safemath.sol";

contract ZombieFactory is Ownable {

  // 2. åœ¨è¿™é‡Œå®šä¹‰ using safemath 
  using SafeMath for uint256;

  event NewZombie(uint zombieId, string name, uint dna);

  uint dnaDigits = 16;
  uint dnaModulus = 10 ** dnaDigits;
  uint cooldownTime = 1 days;

  struct Zombie {
    string name;
    uint dna;
    uint32 level;
    uint32 readyTime;
    uint16 winCount;
    uint16 lossCount;
  }

  Zombie[] public zombies;

  mapping (uint => address) public zombieToOwner;
  mapping (address => uint) ownerZombieCount;

  function _createZombie(string _name, uint _dna) internal {
    uint id = zombies.push(Zombie(_name, _dna, 1, uint32(now + cooldownTime), 0, 0)) - 1;
    zombieToOwner[id] = msg.sender;
    ownerZombieCount[msg.sender]++;
    NewZombie(id, _name, _dna);
  }

  function _generateRandomDna(string _str) private view returns (uint) {
    uint rand = uint(keccak256(_str));
    return rand % dnaModulus;
  }

  function createRandomZombie(string _name) public {
    require(ownerZombieCount[msg.sender] == 0);
    uint randDna = _generateRandomDna(_name);
    randDna = randDna - randDna % 100;
    _createZombie(_name, randDna);
  }

}

```

## ç¬¬10ç« : SafeMath ç¬¬äºŒéƒ¨åˆ†

æ¥çœ‹çœ‹ SafeMath çš„éƒ¨åˆ†ä»£ç :

```
library SafeMath {

  function mul(uint256 a, uint256 b) internal pure returns (uint256) {
    if (a == 0) {
      return 0;
    }
    uint256 c = a * b;
    assert(c / a == b);
    return c;
  }

  function div(uint256 a, uint256 b) internal pure returns (uint256) {
    // assert(b > 0); // Solidity automatically throws when dividing by 0
    uint256 c = a / b;
    // assert(a == b * c + a % b); // There is no case in which this doesn't hold
    return c;
  }

  function sub(uint256 a, uint256 b) internal pure returns (uint256) {
    assert(b <= a);
    return a - b;
  }

  function add(uint256 a, uint256 b) internal pure returns (uint256) {
    uint256 c = a + b;
    assert(c >= a);
    return c;
  }
}
```

é¦–å…ˆæˆ‘ä»¬æœ‰äº† `library` å…³é”®å­— â€” åº“å’Œ `åˆçº¦`å¾ˆç›¸ä¼¼ï¼Œä½†æ˜¯åˆæœ‰ä¸€äº›ä¸åŒã€‚ å°±æˆ‘ä»¬çš„ç›®çš„è€Œè¨€ï¼Œåº“å…è®¸æˆ‘ä»¬ä½¿ç”¨ `using` å…³é”®å­—ï¼Œå®ƒå¯ä»¥è‡ªåŠ¨æŠŠåº“çš„æ‰€æœ‰æ–¹æ³•æ·»åŠ ç»™ä¸€ä¸ªæ•°æ®ç±»å‹ï¼š

```
using SafeMath for uint;
// è¿™ä¸‹æˆ‘ä»¬å¯ä»¥ä¸ºä»»ä½• uint è°ƒç”¨è¿™äº›æ–¹æ³•äº†
uint test = 2;
test = test.mul(3); // test ç­‰äº 6 äº†
test = test.add(5); // test ç­‰äº 11 äº†
```

æ³¨æ„ `mul` å’Œ `add` å…¶å®éƒ½éœ€è¦ä¸¤ä¸ªå‚æ•°ã€‚ åœ¨æˆ‘ä»¬å£°æ˜äº† `using SafeMath for uint` åï¼Œæˆ‘ä»¬ç”¨æ¥è°ƒç”¨è¿™äº›æ–¹æ³•çš„ `uint` å°±è‡ªåŠ¨è¢«ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ä¼ é€’è¿›å»äº†(åœ¨æ­¤ä¾‹ä¸­å°±æ˜¯ `test`)

æˆ‘ä»¬æ¥çœ‹çœ‹ `add` çš„æºä»£ç çœ‹ SafeMath åšäº†ä»€ä¹ˆ:

```
function add(uint256 a, uint256 b) internal pure returns (uint256) {
  uint256 c = a + b;
  assert(c >= a);
  return c;
}
```

åŸºæœ¬ä¸Š `add` åªæ˜¯åƒ `+` ä¸€æ ·å¯¹ä¸¤ä¸ª `uint` ç›¸åŠ ï¼Œ ä½†æ˜¯å®ƒç”¨ä¸€ä¸ª `assert` è¯­å¥æ¥ç¡®ä¿ç»“æœå¤§äº `a`ã€‚è¿™æ ·å°±é˜²æ­¢äº†æº¢å‡ºã€‚

`assert` å’Œ `require` ç›¸ä¼¼ï¼Œè‹¥ç»“æœä¸ºå¦å®ƒå°±ä¼šæŠ›å‡ºé”™è¯¯ã€‚ `assert` å’Œ `require` åŒºåˆ«åœ¨äºï¼Œ`require` è‹¥å¤±è´¥åˆ™ä¼šè¿”è¿˜ç»™ç”¨æˆ·å‰©ä¸‹çš„ gasï¼Œ `assert` åˆ™ä¸ä¼šã€‚æ‰€ä»¥å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œä½ å†™ä»£ç çš„æ—¶å€™ä¼šæ¯”è¾ƒå–œæ¬¢ `require`ï¼Œ`assert` åªåœ¨ä»£ç å¯èƒ½å‡ºç°ä¸¥é‡é”™è¯¯çš„æ—¶å€™ä½¿ç”¨ï¼Œæ¯”å¦‚ `uint` æº¢å‡ºã€‚

æ‰€ä»¥ç®€è€Œè¨€ä¹‹ï¼Œ SafeMath çš„ `add`ï¼Œ `sub`ï¼Œ `mul`ï¼Œ å’Œ `div` æ–¹æ³•åªåšç®€å•çš„å››åˆ™è¿ç®—ï¼Œç„¶ååœ¨å‘ç”Ÿæº¢å‡ºæˆ–ä¸‹æº¢çš„æ—¶å€™æŠ›å‡ºé”™è¯¯ã€‚

### åœ¨æˆ‘ä»¬çš„ä»£ç é‡Œä½¿ç”¨ SafeMathã€‚

ä¸ºäº†é˜²æ­¢æº¢å‡ºå’Œä¸‹æº¢ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æˆ‘ä»¬çš„ä»£ç é‡Œæ‰¾ `+`ï¼Œ `-`ï¼Œ `*`ï¼Œ æˆ– `/`ï¼Œç„¶åæ›¿æ¢ä¸º `add`, `sub`, `mul`, `div`.

æ¯”å¦‚ï¼Œä¸å…¶è¿™æ ·åš:

```
myUint++;
```

æˆ‘ä»¬è¿™æ ·åšï¼š

```
myUint = myUint.add(1);
```

### å®æˆ˜æ¼”ä¹ 

åœ¨ `ZombieOwnership` ä¸­æœ‰ä¸¤ä¸ªåœ°æ–¹ç”¨åˆ°äº†æ•°å­¦è¿ç®—ï¼Œæ¥æ›¿æ¢æˆ SafeMath æ–¹æ³•æŠŠã€‚

1. å°† `++` æ›¿æ¢æˆ SafeMath æ–¹æ³•ã€‚
2. å°† `--` æ›¿æ¢æˆ SafeMath æ–¹æ³•ã€‚

```solidity
pragma solidity ^0.4.19;

import "./zombieattack.sol";
import "./erc721.sol";
import "./safemath.sol";

contract ZombieOwnership is ZombieAttack, ERC721 {

  using SafeMath for uint256;

  mapping (uint => address) zombieApprovals;

  function balanceOf(address _owner) public view returns (uint256 _balance) {
    return ownerZombieCount[_owner];
  }

  function ownerOf(uint256 _tokenId) public view returns (address _owner) {
    return zombieToOwner[_tokenId];
  }

  function _transfer(address _from, address _to, uint256 _tokenId) private {
    // 1. æ›¿æ¢æˆ SafeMath çš„ `add`
    ownerZombieCount[_to] = ownerZombieCount[_to].add(1);
    // 2. æ›¿æ¢æˆ SafeMath çš„ `sub`
    ownerZombieCount[_from] = ownerZombieCount[_from].sub(1);
    zombieToOwner[_tokenId] = _to;
    Transfer(_from, _to, _tokenId);
  }

  function transfer(address _to, uint256 _tokenId) public onlyOwnerOf(_tokenId) {
    _transfer(msg.sender, _to, _tokenId);
  }

  function approve(address _to, uint256 _tokenId) public onlyOwnerOf(_tokenId) {
    zombieApprovals[_tokenId] = _to;
    Approval(msg.sender, _to, _tokenId);
  }

  function takeOwnership(uint256 _tokenId) public {
    require(zombieApprovals[_tokenId] == msg.sender);
    address owner = ownerOf(_tokenId);
    _transfer(owner, msg.sender, _tokenId);
  }
}

```

## ç¬¬11ç« : SafeMath ç¬¬ä¸‰éƒ¨åˆ†

å¤ªå¥½äº†ï¼Œè¿™ä¸‹æˆ‘ä»¬çš„ ERC721 å®ç°ä¸ä¼šæœ‰æº¢å‡ºæˆ–è€…ä¸‹æº¢äº†ã€‚

å›å¤´çœ‹çœ‹æˆ‘ä»¬åœ¨ä¹‹å‰è¯¾ç¨‹å†™çš„ä»£ç ï¼Œè¿˜æœ‰å…¶ä»–å‡ ä¸ªåœ°æ–¹ä¹Ÿæœ‰å¯èƒ½å¯¼è‡´æº¢å‡ºæˆ–ä¸‹æº¢ã€‚

æ¯”å¦‚ï¼Œ åœ¨ ZombieAttack é‡Œé¢æˆ‘ä»¬æœ‰ï¼š

```
myZombie.winCount++;
myZombie.level++;
enemyZombie.lossCount++;
```

æˆ‘ä»¬åŒæ ·åº”è¯¥åœ¨è¿™äº›åœ°æ–¹é˜²æ­¢æº¢å‡ºã€‚ï¼ˆé€šå¸¸æƒ…å†µä¸‹ï¼Œæ€»æ˜¯ä½¿ç”¨ SafeMath è€Œä¸æ˜¯æ™®é€šæ•°å­¦è¿ç®—æ˜¯ä¸ªå¥½ä¸»æ„ï¼Œä¹Ÿè®¸åœ¨ä»¥å Solidity çš„æ–°ç‰ˆæœ¬é‡Œè¿™ç‚¹ä¼šè¢«é»˜è®¤å®ç°ï¼Œä½†æ˜¯ç°åœ¨æˆ‘ä»¬å¾—è‡ªå·±åœ¨ä»£ç é‡Œå®ç°è¿™äº›é¢å¤–çš„å®‰å…¨æªæ–½ï¼‰ã€‚

ä¸è¿‡æˆ‘ä»¬é‡åˆ°ä¸ªå°é—®é¢˜ â€” `winCount` å’Œ `lossCount` æ˜¯ `uint16`ï¼Œ è€Œ `level` æ˜¯ `uint32`ã€‚ æ‰€ä»¥å¦‚æœæˆ‘ä»¬ç”¨è¿™äº›ä½œä¸ºå‚æ•°ä¼ å…¥ SafeMath çš„ `add` æ–¹æ³•ã€‚ å®ƒå®é™…ä¸Šå¹¶ä¸ä¼šé˜²æ­¢æº¢å‡ºï¼Œå› ä¸ºå®ƒä¼šæŠŠè¿™äº›å˜é‡éƒ½è½¬æ¢æˆ `uint256`:

```
function add(uint256 a, uint256 b) internal pure returns (uint256) {
  uint256 c = a + b;
  assert(c >= a);
  return c;
}

// å¦‚æœæˆ‘ä»¬åœ¨`uint8` ä¸Šè°ƒç”¨ `.add`ã€‚å®ƒå°†ä¼šè¢«è½¬æ¢æˆ `uint256`.
// æ‰€ä»¥å®ƒä¸ä¼šåœ¨ 2^8 æ—¶æº¢å‡ºï¼Œå› ä¸º 256 æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ `uint256`.
```

è¿™å°±æ„å‘³ç€ï¼Œæˆ‘ä»¬éœ€è¦å†å®ç°ä¸¤ä¸ªåº“æ¥é˜²æ­¢ `uint16` å’Œ `uint32` æº¢å‡ºæˆ–ä¸‹æº¢ã€‚æˆ‘ä»¬å¯ä»¥å°†å…¶å‘½åä¸º `SafeMath16` å’Œ `SafeMath32`ã€‚

ä»£ç å°†å’Œ SafeMath å®Œå…¨ç›¸åŒï¼Œé™¤äº†æ‰€æœ‰çš„ `uint256` å®ä¾‹éƒ½å°†è¢«æ›¿æ¢æˆ `uint32` æˆ– `uint16`ã€‚

æˆ‘ä»¬å·²ç»å°†è¿™äº›ä»£ç å¸®ä½ å†™å¥½äº†ï¼Œæ‰“å¼€ `safemath.sol` åˆçº¦çœ‹çœ‹ä»£ç å§ã€‚

ç°åœ¨æˆ‘ä»¬éœ€è¦åœ¨ ZombieFactory é‡Œä½¿ç”¨å®ƒä»¬ã€‚

### Putting it to the Test

åˆ†é…ï¼š

1. å£°æ˜æˆ‘ä»¬å°†ä¸º `uint32` ä½¿ç”¨`SafeMath32`ã€‚
2. å£°æ˜æˆ‘ä»¬å°†ä¸º `uint16` ä½¿ç”¨`SafeMath16`ã€‚
3. åœ¨ ZombieFactory é‡Œè¿˜æœ‰ä¸€å¤„æˆ‘ä»¬ä¹Ÿåº”è¯¥ä½¿ç”¨ SafeMath çš„æ–¹æ³•ï¼Œ æˆ‘ä»¬å·²ç»åœ¨é‚£é‡Œç•™äº†æ³¨é‡Šæé†’ä½ ã€‚

```
pragma solidity ^0.4.19;

import "./ownable.sol";
import "./safemath.sol";

contract ZombieFactory is Ownable {

  using SafeMath for uint256;
  // 1. ä¸º uint32 å£°æ˜ ä½¿ç”¨ SafeMath32
  using SafeMath32 for uint32;
  // 2. ä¸º uint16 å£°æ˜ ä½¿ç”¨ SafeMath16
  using SafeMath16 for uint16; 

  event NewZombie(uint zombieId, string name, uint dna);

  uint dnaDigits = 16;
  uint dnaModulus = 10 ** dnaDigits;
  uint cooldownTime = 1 days;

  struct Zombie {
    string name;
    uint dna;
    uint32 level;
    uint32 readyTime;
    uint16 winCount;
    uint16 lossCount;
  }

  Zombie[] public zombies;

  mapping (uint => address) public zombieToOwner;
  mapping (address => uint) ownerZombieCount;

  function _createZombie(string _name, uint _dna) internal {
    // æ³¨æ„: æˆ‘ä»¬é€‰æ‹©ä¸å¤„ç†2038å¹´é—®é¢˜ï¼Œæ‰€ä»¥ä¸ç”¨æ‹…å¿ƒ readyTime çš„æº¢å‡º
    // åæ­£åœ¨2038å¹´æˆ‘ä»¬çš„APPæ—©å®Œè›‹äº†
    uint id = zombies.push(Zombie(_name, _dna, 1, uint32(now + cooldownTime), 0, 0)) - 1;
    zombieToOwner[id] = msg.sender;
    // 3. åœ¨è¿™é‡Œä½¿ç”¨ SafeMath çš„ `add` æ–¹æ³•:
    ownerZombieCount[msg.sender] = ownerZombieCount[msg.sender].add(1);
    NewZombie(id, _name, _dna);
  }

  function _generateRandomDna(string _str) private view returns (uint) {
    uint rand = uint(keccak256(_str));
    return rand % dnaModulus;
  }

  function createRandomZombie(string _name) public {
    require(ownerZombieCount[msg.sender] == 0);
    uint randDna = _generateRandomDna(_name);
    randDna = randDna - randDna % 100;
    _createZombie(_name, randDna);
  }

}

```

## ç¬¬12ç« : SafeMath ç¬¬4éƒ¨åˆ†

çœŸæ£’ï¼Œç°åœ¨æˆ‘ä»¬å·²ç»ä¸ºæˆ‘ä»¬çš„ DApp é‡Œé¢ç”¨åˆ°çš„ `uint` æ•°æ®ç±»å‹éƒ½å®ç°äº† SafeMath äº†ã€‚

è®©æˆ‘ä»¬æŠŠ `ZombieAttack` é‡Œæ‰€æœ‰æ½œåœ¨çš„é—®é¢˜éƒ½ä¿®å¤äº†å§ã€‚ ï¼ˆå…¶å®åœ¨ `ZombieHelper`é‡Œä¹Ÿæœ‰ä¸€å¤„ `zombies[_zombieId].level++;` éœ€è¦ä¿®å¤ï¼Œä¸è¿‡æˆ‘ä»¬å·²ç»å¸®ä½ åšå¥½äº†ï¼Œè¿™æ ·æˆ‘ä»¬å°±ä¸ç”¨å†æ¥ä¸€ç« äº† ğŸ˜‰ï¼‰ã€‚

### å®æˆ˜æ¼”ä¹ 

æ”¾å¿ƒå¤§èƒ†å»å¯¹ `ZombieAttack` é‡Œæ‰€æœ‰çš„ `++` æ“ä½œéƒ½ä½¿ç”¨ SafeMath æ–¹æ³•å§ã€‚ä¸ºäº†æ–¹ä¾¿ä½ æ‰¾ï¼Œæˆ‘ä»¬å·²ç»åœ¨ç›¸åº”çš„åœ°æ–¹ç•™äº†æ³¨é‡Šç»™ä½ ã€‚

```
pragma solidity ^0.4.19;

import "./zombiehelper.sol";

contract ZombieBattle is ZombieHelper {
  uint randNonce = 0;
  uint attackVictoryProbability = 70;

  function randMod(uint _modulus) internal returns(uint) {
    // è¿™å„¿æœ‰ä¸€ä¸ª
    randNonce = randNonce.add(1);
    return uint(keccak256(now, msg.sender, randNonce)) % _modulus;
  }

  function attack(uint _zombieId, uint _targetId) external onlyOwnerOf(_zombieId) {
    Zombie storage myZombie = zombies[_zombieId];
    Zombie storage enemyZombie = zombies[_targetId];
    uint rand = randMod(100);
    if (rand <= attackVictoryProbability) {
      // è¿™é‡Œæœ‰ä¸‰ä¸ª
      myZombie.winCount = myZombie.winCount.add(1);
      myZombie.level = myZombie.level.add(1);
      enemyZombie.lossCount = enemyZombie.lossCount.add(1);
      feedAndMultiply(_zombieId, enemyZombie.dna, "zombie");
    } else {
      // è¿™å„¿è¿˜æœ‰ä¿©å“¦
      myZombie.lossCount = myZombie.lossCount.add(1);
      enemyZombie.winCount = enemyZombie.winCount.add(1);
      _triggerCooldown(myZombie);
    }
  }
}

```



## ç¬¬13ç« : æ³¨é‡Š

åƒµå°¸æ¸¸æˆçš„ Solidity ä»£ç ç»ˆäºå®Œæˆå•¦ã€‚

åœ¨ä»¥åçš„è¯¾ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ å¦‚ä½•å°†æ¸¸æˆéƒ¨ç½²åˆ°ä»¥å¤ªåŠï¼Œä»¥åŠå¦‚ä½•å’Œ Web3.js äº¤äº’ã€‚

ä¸è¿‡åœ¨ä½ ç¦»å¼€ç¬¬äº”è¯¾ä¹‹å‰ï¼Œæˆ‘ä»¬æ¥è°ˆè°ˆå¦‚ä½• **ç»™ä½ çš„ä»£ç æ·»åŠ æ³¨é‡Š**.

### æ³¨é‡Šè¯­æ³•

Solidity é‡Œçš„æ³¨é‡Šå’Œ JavaScript ç›¸åŒã€‚åœ¨æˆ‘ä»¬çš„è¯¾ç¨‹ä¸­ä½ å·²ç»çœ‹åˆ°äº†ä¸å°‘å•è¡Œæ³¨é‡Šäº†ï¼š

```
// è¿™æ˜¯ä¸€ä¸ªå•è¡Œæ³¨é‡Šï¼Œå¯ä»¥ç†è§£ä¸ºç»™è‡ªå·±æˆ–è€…åˆ«äººçœ‹çš„ç¬”è®°
```

åªè¦åœ¨ä»»ä½•åœ°æ–¹æ·»åŠ ä¸€ä¸ª `//` å°±æ„å‘³ç€ä½ åœ¨æ³¨é‡Šã€‚å¦‚æ­¤ç®€å•æ‰€ä»¥ä½ åº”è¯¥ç»å¸¸è¿™ä¹ˆåšã€‚

ä¸è¿‡æˆ‘ä»¬ä¹ŸçŸ¥é“ä½ çš„æƒ³æ³•ï¼šæœ‰æ—¶å€™å•è¡Œæ³¨é‡Šæ˜¯ä¸å¤Ÿçš„ã€‚æ¯•ç«Ÿä½ ç”Ÿæ¥è¯ç—¨ã€‚

æ‰€ä»¥æˆ‘ä»¬æœ‰äº†å¤šè¡Œæ³¨é‡Šï¼š

```
ontract CryptoZombies { 
  /* è¿™æ˜¯ä¸€ä¸ªå¤šè¡Œæ³¨é‡Šã€‚æˆ‘æƒ³å¯¹æ‰€æœ‰èŠ±æ—¶é—´æ¥å°è¯•è¿™ä¸ªç¼–ç¨‹è¯¾ç¨‹çš„äººè¯´å£°è°¢è°¢ã€‚
  å®ƒæ˜¯å…è´¹çš„ï¼Œå¹¶å°†æ°¸è¿œå…è´¹ã€‚ä½†æ˜¯æˆ‘ä»¬ä¾ç„¶å€¾æ³¨äº†æˆ‘ä»¬çš„å¿ƒè¡€æ¥è®©å®ƒå˜å¾—æ›´å¥½ã€‚

   è¦çŸ¥é“è¿™ä¾ç„¶åªæ˜¯åŒºå—é“¾å¼€å‘çš„å¼€å§‹è€Œå·²ï¼Œè™½ç„¶æˆ‘ä»¬å·²ç»èµ°äº†å¾ˆè¿œ.
  */
}
```

ç‰¹åˆ«æ˜¯ï¼Œæœ€å¥½ä¸ºä½ åˆçº¦ä¸­æ¯ä¸ªæ–¹æ³•æ·»åŠ æ³¨é‡Šæ¥è§£é‡Šå®ƒçš„é¢„æœŸè¡Œä¸ºã€‚è¿™æ ·å…¶ä»–å¼€å‘è€…ï¼ˆæˆ–è€…ä½ è‡ªå·±ï¼Œåœ¨6ä¸ªæœˆä»¥åå†å›åˆ°è¿™ä¸ªé¡¹ç›®ä¸­ï¼‰å¯ä»¥å¾ˆå¿«åœ°ç†è§£ä½ çš„ä»£ç è€Œä¸éœ€è¦é€è¡Œé˜…è¯»æ‰€æœ‰ä»£ç ã€‚

Solidity ç¤¾åŒºæ‰€ä½¿ç”¨çš„ä¸€ä¸ªæ ‡å‡†æ˜¯ä½¿ç”¨ä¸€ç§è¢«ç§°ä½œ **natspec** çš„æ ¼å¼ï¼Œçœ‹èµ·æ¥åƒè¿™æ ·ï¼š

```
/// @title ä¸€ä¸ªç®€å•çš„åŸºç¡€è¿ç®—åˆçº¦
/// @author H4XF13LD MORRIS ğŸ’¯ğŸ’¯ğŸ˜ğŸ’¯ğŸ’¯
/// @notice ç°åœ¨ï¼Œè¿™ä¸ªåˆçº¦åªæ·»åŠ ä¸€ä¸ªä¹˜æ³•
contract Math {
  /// @notice ä¸¤ä¸ªæ•°ç›¸ä¹˜
  /// @param x ç¬¬ä¸€ä¸ª uint
  /// @param y  ç¬¬äºŒä¸ª uint
  /// @return z  (x * y) çš„ç»“æœ
  /// @dev ç°åœ¨è¿™ä¸ªæ–¹æ³•ä¸æ£€æŸ¥æº¢å‡º
  function multiply(uint x, uint y) returns (uint z) {
    // è¿™åªæ˜¯ä¸ªæ™®é€šçš„æ³¨é‡Šï¼Œä¸ä¼šè¢« natspec è§£é‡Š
    z = x * y;
  }
}
```

`@title`ï¼ˆæ ‡é¢˜ï¼‰ å’Œ `@author` ï¼ˆä½œè€…ï¼‰å¾ˆç›´æ¥äº†.

`@notice` ï¼ˆé¡»çŸ¥ï¼‰å‘ **ç”¨æˆ·** è§£é‡Šè¿™ä¸ªæ–¹æ³•æˆ–è€…åˆçº¦æ˜¯åšä»€ä¹ˆçš„ã€‚ `@dev` ï¼ˆå¼€å‘è€…ï¼‰ æ˜¯å‘å¼€å‘è€…è§£é‡Šæ›´å¤šçš„ç»†èŠ‚ã€‚

`@param` ï¼ˆå‚æ•°ï¼‰å’Œ `@return` ï¼ˆè¿”å›ï¼‰ ç”¨æ¥æè¿°è¿™ä¸ªæ–¹æ³•éœ€è¦ä¼ å…¥ä»€ä¹ˆå‚æ•°ä»¥åŠè¿”å›ä»€ä¹ˆå€¼ã€‚

æ³¨æ„ä½ å¹¶ä¸éœ€è¦æ¯æ¬¡éƒ½ç”¨ä¸Šæ‰€æœ‰çš„æ ‡ç­¾ï¼Œå®ƒä»¬éƒ½æ˜¯å¯é€‰çš„ã€‚ä¸è¿‡æœ€å°‘ï¼Œå†™ä¸‹ä¸€ä¸ª `@dev` æ³¨é‡Šæ¥è§£é‡Šæ¯ä¸ªæ–¹æ³•æ˜¯åšä»€ä¹ˆçš„ã€‚

### å®æˆ˜æ¼”ä¹ 

å¦‚æœä½ è¿˜æ²¡æ³¨æ„åˆ°ï¼šCryptoZombies çš„ç­”æ¡ˆæ£€æŸ¥å™¨åœ¨å·¥ä½œçš„æ—¶å€™å°†å¿½ç•¥æ‰€æœ‰çš„æ³¨é‡Šã€‚æ‰€ä»¥è¿™ä¸€ç« æˆ‘ä»¬å…¶å®æ— æ³•æ£€æŸ¥ä½ çš„ natspec æ³¨é‡Šäº†ã€‚å…¨é ä½ è‡ªå·±å’¯ã€‚

è¯è¯´å›æ¥ï¼Œåˆ°ç°åœ¨ä½ åº”è¯¥å·²ç»æ˜¯ä¸€ä¸ª Solidity å°èƒ½æ‰‹äº†ã€‚æˆ‘ä»¬å°±å‡å®šä½ å·²ç»å­¦ä¼šè¿™äº›äº†ã€‚

å¤§èƒ†å»åšäº›å°è¯•æŠŠï¼Œç»™ `ZombieOwnership` åŠ ä¸Šä¸€äº› natspec æ ‡ç­¾:

1. `@title` â€” ä¾‹å¦‚ï¼šä¸€ä¸ªç®¡ç†è½¬ç§»åƒµå°¸æ‰€æœ‰æƒçš„åˆçº¦
2. `@author` â€” ä½ çš„åå­—
3. `@dev` â€” ä¾‹å¦‚ï¼šç¬¦åˆ OpenZeppelin å¯¹ ERC721 æ ‡å‡†è‰æ¡ˆçš„å®ç°

```
pragma solidity ^0.4.19;

import "./zombieattack.sol";
import "./erc721.sol";
import "./safemath.sol";

/// TODO: æŠŠè¿™é‡Œå˜æˆ natspec æ ‡å‡†çš„æ³¨é‡ŠæŠŠ
/// @title ä¸€ä¸ªç®¡ç†è½¬ç§»åƒµå°¸æ‰€æœ‰æƒçš„åˆçº¦
/// @author Alcalde
/// @dev â€” ä¾‹å¦‚ï¼šç¬¦åˆ OpenZeppelin å¯¹ ERC721 æ ‡å‡†è‰æ¡ˆçš„å®ç°
ä¸€ä¸ªç®¡ç†è½¬ç§»åƒµå°¸æ‰€æœ‰æƒçš„åˆçº¦
contract ZombieOwnership is ZombieAttack, ERC721 {

  using SafeMath for uint256;

  mapping (uint => address) zombieApprovals;

  function balanceOf(address _owner) public view returns (uint256 _balance) {
    return ownerZombieCount[_owner];
  }

  function ownerOf(uint256 _tokenId) public view returns (address _owner) {
    return zombieToOwner[_tokenId];
  }

  function _transfer(address _from, address _to, uint256 _tokenId) private {
    ownerZombieCount[_to] = ownerZombieCount[_to].add(1);
    ownerZombieCount[msg.sender] = ownerZombieCount[msg.sender].sub(1);
    zombieToOwner[_tokenId] = _to;
    Transfer(_from, _to, _tokenId);
  }

  function transfer(address _to, uint256 _tokenId) public onlyOwnerOf(_tokenId) {
    _transfer(msg.sender, _to, _tokenId);
  }

  function approve(address _to, uint256 _tokenId) public onlyOwnerOf(_tokenId) {
    zombieApprovals[_tokenId] = _to;
    Approval(msg.sender, _to, _tokenId);
  }

  function takeOwnership(uint256 _tokenId) public {
    require(zombieApprovals[_tokenId] == msg.sender);
    address owner = ownerOf(_tokenId);
    _transfer(owner, msg.sender, _tokenId);
  }
}

```

# å…­ã€åº”ç”¨å‰ç«¯å’Œ Web3.js

# ç¬¬1ç« : ä»‹ç» Web3.js

å®Œæˆç¬¬äº”è¯¾ä»¥åï¼Œæˆ‘ä»¬çš„åƒµå°¸ DApp çš„ Solidity åˆçº¦éƒ¨åˆ†å°±å®Œæˆäº†ã€‚ç°åœ¨æˆ‘ä»¬æ¥åšä¸€ä¸ªåŸºæœ¬çš„ç½‘é¡µå¥½è®©ä½ çš„ç”¨æˆ·èƒ½ç©å®ƒã€‚ è¦åšåˆ°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä»¥å¤ªåŠåŸºé‡‘å‘å¸ƒçš„ JavaScript åº“ â€”â€” **Web3.js**.

## ä»€ä¹ˆæ˜¯ Web3.js?

è¿˜è®°å¾—ä¹ˆï¼Ÿä»¥å¤ªåŠç½‘ç»œæ˜¯ç”±èŠ‚ç‚¹ç»„æˆçš„ï¼Œæ¯ä¸€ä¸ªèŠ‚ç‚¹éƒ½åŒ…å«äº†åŒºå—é“¾çš„ä¸€ä»½æ‹·è´ã€‚å½“ä½ æƒ³è¦è°ƒç”¨ä¸€ä»½æ™ºèƒ½åˆçº¦çš„ä¸€ä¸ªæ–¹æ³•ï¼Œä½ éœ€è¦ä»å…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹ä¸­æŸ¥æ‰¾å¹¶å‘Šè¯‰å®ƒ:

1. æ™ºèƒ½åˆçº¦çš„åœ°å€
2. ä½ æƒ³è°ƒç”¨çš„æ–¹æ³•ï¼Œä»¥åŠ
3. ä½ æƒ³ä¼ å…¥é‚£ä¸ªæ–¹æ³•çš„å‚æ•°

ä»¥å¤ªåŠèŠ‚ç‚¹åªèƒ½è¯†åˆ«ä¸€ç§å«åš **JSON-RPC** çš„è¯­è¨€ã€‚è¿™ç§è¯­è¨€ç›´æ¥è¯»èµ·æ¥å¹¶ä¸å¥½æ‡‚ã€‚å½“ä½ ä½ æƒ³è°ƒç”¨ä¸€ä¸ªåˆçº¦çš„æ–¹æ³•çš„æ—¶å€™ï¼Œéœ€è¦å‘é€çš„æŸ¥è¯¢è¯­å¥å°†ä¼šæ˜¯è¿™æ ·çš„ï¼š

```
// å“ˆâ€¦â€¦ç¥ä½ å†™æ‰€æœ‰è¿™æ ·çš„å‡½æ•°è°ƒç”¨çš„æ—¶å€™éƒ½ä¸€æ¬¡é€šè¿‡
// å¾€å³è¾¹æ‹‰â€¦â€¦ ==>
{"jsonrpc":"2.0","method":"eth_sendTransaction","params":[{"from":"0xb60e8dd61c5d32be8058bb8eb970870f07233155","to":"0xd46e8dd67c5d32be8058bb8eb970870f07244567","gas":"0x76c0","gasPrice":"0x9184e72a000","value":"0x9184e72a","data":"0xd46e8dd67c5d32be8d46e8dd67c5d32be8058bb8eb970870f072445675058bb8eb970870f072445675"}],"id":1}
```

å¹¸è¿çš„æ˜¯ Web3.js æŠŠè¿™äº›ä»¤äººè®¨åŒçš„æŸ¥è¯¢è¯­å¥éƒ½éšè—èµ·æ¥äº†ï¼Œ æ‰€ä»¥ä½ åªéœ€è¦ä¸æ–¹ä¾¿æ˜“æ‡‚çš„ JavaScript ç•Œé¢è¿›è¡Œäº¤äº’å³å¯ã€‚

ä½ ä¸éœ€è¦æ„å»ºä¸Šé¢çš„æŸ¥è¯¢è¯­å¥ï¼Œåœ¨ä½ çš„ä»£ç ä¸­è°ƒç”¨ä¸€ä¸ªå‡½æ•°çœ‹èµ·æ¥å°†æ˜¯è¿™æ ·ï¼š

```
CryptoZombies.methods.createRandomZombie("Vitalik Nakamoto ğŸ¤”")
  .send({ from: "0xb60e8dd61c5d32be8058bb8eb970870f07233155", gas: "3000000" })
```

æˆ‘ä»¬å°†åœ¨æ¥ä¸‹æ¥çš„å‡ ç« è¯¦ç»†è§£é‡Šè¿™äº›è¯­å¥ï¼Œä¸è¿‡é¦–å…ˆæˆ‘ä»¬æ¥æŠŠ Web3.js ç¯å¢ƒæ­å»ºèµ·æ¥ã€‚

## å‡†å¤‡å¥½äº†ä¹ˆï¼Ÿ

å–å†³äºä½ çš„é¡¹ç›®å·¥ä½œæµç¨‹å’Œä½ çš„çˆ±å¥½ï¼Œä½ å¯ä»¥ç”¨ä¸€äº›å¸¸ç”¨å·¥å…·æŠŠ Web3.js æ·»åŠ è¿›æ¥ï¼š

```
// ç”¨ NPM
npm install web3

// ç”¨ Yarn
yarn add web3

// ç”¨ Bower
bower install web3

// ...æˆ–è€…å…¶ä»–ã€‚
```

ç”šè‡³ï¼Œä½ å¯ä»¥ä» [github](https://github.com/ethereum/web3.js/blob/1.0/dist/web3.min.js) ç›´æ¥ä¸‹è½½å‹ç¼©åçš„ `.js` æ–‡ä»¶ ç„¶ååŒ…å«åˆ°ä½ çš„é¡¹ç›®æ–‡ä»¶ä¸­ï¼š

```
<script language="javascript" type="text/javascript" src="web3.min.js"></script>
```

å› ä¸ºæˆ‘ä»¬ä¸æƒ³è®©ä½ èŠ±å¤ªå¤šåœ¨é¡¹ç›®ç¯å¢ƒæ­å»ºä¸Šï¼Œåœ¨æœ¬æ•™ç¨‹ä¸­æˆ‘ä»¬å°†ä½¿ç”¨ä¸Šé¢çš„ `script` æ ‡ç­¾æ¥å°† Web3.js å¼•å…¥ã€‚

## å®æˆ˜æ¼”ä¹ 

æˆ‘ä»¬ä¸ºä½ å»ºç«‹äº†ä¸€ä¸ªHTML é¡¹ç›®ç©ºå£³ â€”â€” `index.html`ã€‚å‡è®¾åœ¨å’Œ `index.html`åŒä¸ªæ–‡ä»¶å¤¹é‡Œæœ‰ä¸€ä»½ `web3.min.js`

1. ä½¿ç”¨ä¸Šé¢çš„ `script` æ ‡ç­¾ä»£ç æŠŠ `web3.js` æ·»åŠ è¿›å»ä»¥å¤‡æ¥ä¸‹æ¥ä½¿ç”¨ã€‚

```
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>CryptoZombies front-end</title>
    <script language="javascript" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <!-- Include web3.js here -->
    <script language="javascript" type="text/javascript" src="web3.min.js"></script>
  </head>
  <body>

  </body>
</html>

```

## ç¬¬2ç« : Web3 æä¾›è€…

å¤ªæ£’äº†ã€‚ç°åœ¨æˆ‘ä»¬çš„é¡¹ç›®ä¸­æœ‰äº†Web3.js, æ¥åˆå§‹åŒ–å®ƒç„¶åå’ŒåŒºå—é“¾å¯¹è¯å§ã€‚

é¦–å…ˆæˆ‘ä»¬éœ€è¦ **Web3 Provider**.

è¦è®°ä½ï¼Œä»¥å¤ªåŠæ˜¯ç”±å…±äº«åŒä¸€ä»½æ•°æ®çš„ç›¸åŒæ‹·è´çš„ **èŠ‚ç‚¹** æ„æˆçš„ã€‚ åœ¨ Web3.js é‡Œè®¾ç½® Web3 çš„ `Provider`ï¼ˆæä¾›è€…ï¼‰ å‘Šè¯‰æˆ‘ä»¬çš„ä»£ç åº”è¯¥å’Œ **å“ªä¸ªèŠ‚ç‚¹** äº¤äº’æ¥å¤„ç†æˆ‘ä»¬çš„è¯»å†™ã€‚è¿™å°±å¥½åƒåœ¨ä¼ ç»Ÿçš„ Web åº”ç”¨ç¨‹åºä¸­ä¸ºä½ çš„ API è°ƒç”¨è®¾ç½®è¿œç¨‹ Web æœåŠ¡å™¨çš„ç½‘å€ã€‚

ä½ å¯ä»¥è¿è¡Œä½ è‡ªå·±çš„ä»¥å¤ªåŠèŠ‚ç‚¹æ¥ä½œä¸º Providerã€‚ ä¸è¿‡ï¼Œæœ‰ä¸€ä¸ªç¬¬ä¸‰æ–¹çš„æœåŠ¡ï¼Œå¯ä»¥è®©ä½ çš„ç”Ÿæ´»å˜å¾—è½»æ¾ç‚¹ï¼Œè®©ä½ ä¸å¿…ä¸ºäº†ç»™ä½ çš„ç”¨æˆ·æä¾›DAppè€Œç»´æŠ¤ä¸€ä¸ªä»¥å¤ªåŠèŠ‚ç‚¹â€” **Infura**.

### Infura

[Infura](https://infura.io/) æ˜¯ä¸€ä¸ªæœåŠ¡ï¼Œå®ƒç»´æŠ¤äº†å¾ˆå¤šä»¥å¤ªåŠèŠ‚ç‚¹å¹¶æä¾›äº†ä¸€ä¸ªç¼“å­˜å±‚æ¥å®ç°é«˜é€Ÿè¯»å–ã€‚ä½ å¯ä»¥ç”¨ä»–ä»¬çš„ API æ¥å…è´¹è®¿é—®è¿™ä¸ªæœåŠ¡ã€‚ ç”¨ Infura ä½œä¸ºèŠ‚ç‚¹æä¾›è€…ï¼Œä½ å¯ä»¥ä¸ç”¨è‡ªå·±è¿è¥èŠ‚ç‚¹å°±èƒ½å¾ˆå¯é åœ°å‘ä»¥å¤ªåŠå‘é€ã€æ¥æ”¶ä¿¡æ¯ã€‚

ä½ å¯ä»¥é€šè¿‡è¿™æ ·æŠŠ Infura ä½œä¸ºä½ çš„ Web3 èŠ‚ç‚¹æä¾›è€…ï¼š

```
var web3 = new Web3(new Web3.providers.WebsocketProvider("wss://mainnet.infura.io/ws"));
```

ä¸è¿‡ï¼Œå› ä¸ºæˆ‘ä»¬çš„ DApp å°†è¢«å¾ˆå¤šäººä½¿ç”¨ï¼Œè¿™äº›ç”¨æˆ·ä¸å•ä¼šä»åŒºå—é“¾è¯»å–ä¿¡æ¯ï¼Œè¿˜ä¼šå‘åŒºå—é“¾ **å†™** å…¥ä¿¡æ¯ï¼Œæˆ‘ä»¬éœ€è¦ç”¨ä¸€ä¸ªæ–¹æ³•è®©ç”¨æˆ·å¯ä»¥ç”¨ä»–ä»¬çš„ç§é’¥ç»™äº‹åŠ¡ç­¾åã€‚

> æ³¨æ„: ä»¥å¤ªåŠ (ä»¥åŠé€šå¸¸æ„ä¹‰ä¸Šçš„ blockchains )ä½¿ç”¨ä¸€ä¸ªå…¬é’¥/ç§é’¥å¯¹æ¥å¯¹ç»™äº‹åŠ¡åšæ•°å­—ç­¾åã€‚æŠŠå®ƒæƒ³æˆä¸€ä¸ªæ•°å­—ç­¾åçš„å¼‚å¸¸å®‰å…¨çš„å¯†ç ã€‚è¿™æ ·å½“æˆ‘ä¿®æ”¹åŒºå—é“¾ä¸Šçš„æ•°æ®çš„æ—¶å€™ï¼Œæˆ‘å¯ä»¥ç”¨æˆ‘çš„å…¬é’¥æ¥ **è¯æ˜** æˆ‘å°±æ˜¯ç­¾åçš„é‚£ä¸ªã€‚ä½†æ˜¯å› ä¸ºæ²¡äººçŸ¥é“æˆ‘çš„ç§é’¥ï¼Œæ‰€ä»¥æ²¡äººèƒ½ä¼ªé€ æˆ‘çš„äº‹åŠ¡ã€‚

åŠ å¯†å­¦éå¸¸å¤æ‚ï¼Œæ‰€ä»¥é™¤éä½ æ˜¯ä¸ªä¸“å®¶å¹¶ä¸”çš„ç¡®çŸ¥é“è‡ªå·±åœ¨åšä»€ä¹ˆï¼Œä½ æœ€å¥½ä¸è¦åœ¨ä½ åº”ç”¨çš„å‰ç«¯ä¸­ç®¡ç†ä½ ç”¨æˆ·çš„ç§é’¥ã€‚

ä¸è¿‡å¹¸è¿çš„æ˜¯ï¼Œä½ å¹¶ä¸éœ€è¦ï¼Œå·²ç»æœ‰å¯ä»¥å¸®ä½ å¤„ç†è¿™ä»¶äº‹çš„æœåŠ¡äº†ï¼š **Metamask**.

### Metamask

[Metamask](https://metamask.io/) æ˜¯ Chrome å’Œ Firefox çš„æµè§ˆå™¨æ‰©å±•ï¼Œ å®ƒèƒ½è®©ç”¨æˆ·å®‰å…¨åœ°ç»´æŠ¤ä»–ä»¬çš„ä»¥å¤ªåŠè´¦æˆ·å’Œç§é’¥ï¼Œ å¹¶ç”¨ä»–ä»¬çš„è´¦æˆ·å’Œä½¿ç”¨ Web3.js çš„ç½‘ç«™äº’åŠ¨ï¼ˆå¦‚æœä½ è¿˜æ²¡ç”¨è¿‡å®ƒï¼Œä½ è‚¯å®šä¼šæƒ³å»å®‰è£…çš„â€”â€”è¿™æ ·ä½ çš„æµè§ˆå™¨å°±èƒ½ä½¿ç”¨ Web3.js äº†ï¼Œç„¶åä½ å°±å¯ä»¥å’Œä»»ä½•ä¸ä»¥å¤ªåŠåŒºå—é“¾é€šä¿¡çš„ç½‘ç«™äº¤äº’äº†ï¼‰

ä½œä¸ºå¼€å‘è€…ï¼Œå¦‚æœä½ æƒ³è®©ç”¨æˆ·ä»ä»–ä»¬çš„æµè§ˆå™¨é‡Œé€šè¿‡ç½‘ç«™å’Œä½ çš„DAppäº¤äº’ï¼ˆå°±åƒæˆ‘ä»¬åœ¨ CryptoZombies æ¸¸æˆé‡Œä¸€æ ·ï¼‰ï¼Œä½ è‚¯å®šä¼šæƒ³è¦å…¼å®¹ Metamask çš„ã€‚

> **æ³¨æ„**: Metamask é»˜è®¤ä½¿ç”¨ Infura çš„æœåŠ¡å™¨åšä¸º web3 æä¾›è€…ã€‚ å°±åƒæˆ‘ä»¬ä¸Šé¢åšçš„é‚£æ ·ã€‚ä¸è¿‡å®ƒè¿˜ä¸ºç”¨æˆ·æä¾›äº†é€‰æ‹©ä»–ä»¬è‡ªå·± Web3 æä¾›è€…çš„é€‰é¡¹ã€‚æ‰€ä»¥ä½¿ç”¨ Metamask çš„ web3 æä¾›è€…ï¼Œä½ å°±ç»™äº†ç”¨æˆ·é€‰æ‹©æƒï¼Œè€Œè‡ªå·±æ— éœ€æ“å¿ƒè¿™ä¸€å—ã€‚

### ä½¿ç”¨ Metamask çš„ web3 æä¾›è€…

Metamask æŠŠå®ƒçš„ web3 æä¾›è€…æ³¨å…¥åˆ°æµè§ˆå™¨çš„å…¨å±€ JavaScriptå¯¹è±¡`web3`ä¸­ã€‚æ‰€ä»¥ä½ çš„åº”ç”¨å¯ä»¥æ£€æŸ¥ `web3` æ˜¯å¦å­˜åœ¨ã€‚è‹¥å­˜åœ¨å°±ä½¿ç”¨ `web3.currentProvider` ä½œä¸ºå®ƒçš„æä¾›è€…ã€‚

è¿™é‡Œæ˜¯ä¸€äº› Metamask æä¾›çš„ç¤ºä¾‹ä»£ç ï¼Œç”¨æ¥æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å®‰è£…äº†MetaMaskï¼Œå¦‚æœæ²¡æœ‰å®‰è£…å°±å‘Šè¯‰ç”¨æˆ·éœ€è¦å®‰è£…MetaMaskæ¥ä½¿ç”¨æˆ‘ä»¬çš„åº”ç”¨ã€‚

```
window.addEventListener('load', function() {

  // æ£€æŸ¥web3æ˜¯å¦å·²ç»æ³¨å…¥åˆ°(Mist/MetaMask)
  if (typeof web3 !== 'undefined') {
    // ä½¿ç”¨ Mist/MetaMask çš„æä¾›è€…
    web3js = new Web3(web3.currentProvider);
  } else {
    // å¤„ç†ç”¨æˆ·æ²¡å®‰è£…çš„æƒ…å†µï¼Œ æ¯”å¦‚æ˜¾ç¤ºä¸€ä¸ªæ¶ˆæ¯
    // å‘Šè¯‰ä»–ä»¬è¦å®‰è£… MetaMask æ¥ä½¿ç”¨æˆ‘ä»¬çš„åº”ç”¨
  }

  // ç°åœ¨ä½ å¯ä»¥å¯åŠ¨ä½ çš„åº”ç”¨å¹¶è‡ªç”±è®¿é—® Web3.js:
  startApp()

})
```

ä½ å¯ä»¥åœ¨ä½ æ‰€æœ‰çš„åº”ç”¨ä¸­ä½¿ç”¨è¿™æ®µæ ·æ¿ä»£ç ï¼Œå¥½æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å®‰è£…ä»¥åŠå‘Šè¯‰ç”¨æˆ·å®‰è£… MetaMaskã€‚

> æ³¨æ„: é™¤äº†MetaMaskï¼Œä½ çš„ç”¨æˆ·ä¹Ÿå¯èƒ½åœ¨ä½¿ç”¨å…¶ä»–ä»–çš„ç§é’¥ç®¡ç†åº”ç”¨ï¼Œæ¯”å¦‚ **Mist** æµè§ˆå™¨ã€‚ä¸è¿‡ï¼Œå®ƒä»¬éƒ½å®ç°äº†ç›¸åŒçš„æ¨¡å¼æ¥æ³¨å…¥ `web3` å˜é‡ã€‚æ‰€ä»¥æˆ‘è¿™é‡Œæè¿°çš„æ–¹æ³•å¯¹ä¸¤è€…æ˜¯é€šç”¨çš„ã€‚

### å®æˆ˜æ¼”ä¹ 

æˆ‘ä»¬åœ¨HTMLæ–‡ä»¶ä¸­çš„ `</body>` æ ‡ç­¾å‰é¢æ”¾ç½®äº†ä¸€ä¸ªç©ºçš„ `script` æ ‡ç­¾ã€‚å¯ä»¥æŠŠè¿™èŠ‚è¯¾çš„ JavaScript ä»£ç å†™åœ¨é‡Œé¢ã€‚

1. æŠŠä¸Šé¢ç”¨æ¥æ£€æµ‹ MetaMask æ˜¯å¦å®‰è£…çš„æ¨¡æ¿ä»£ç ç²˜è´´è¿›æ¥ã€‚è¯·ç²˜è´´åˆ°ä»¥ `window.addEventListener` å¼€å¤´çš„ä»£ç å—ä¸­ã€‚

```
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>CryptoZombies front-end</title>
    <script language="javascript" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script language="javascript" type="text/javascript" src="web3.min.js"></script>
  </head>
  <body>

    <script>
      // Start here
      window.addEventListener('load', function() {

  // æ£€æŸ¥web3æ˜¯å¦å·²ç»æ³¨å…¥åˆ°(Mist/MetaMask)
  if (typeof web3 !== 'undefined') {
    // ä½¿ç”¨ Mist/MetaMask çš„æä¾›è€…
    web3js = new Web3(web3.currentProvider);
  } else {
    // å¤„ç†ç”¨æˆ·æ²¡å®‰è£…çš„æƒ…å†µï¼Œ æ¯”å¦‚æ˜¾ç¤ºä¸€ä¸ªæ¶ˆæ¯
    // å‘Šè¯‰ä»–ä»¬è¦å®‰è£… MetaMask æ¥ä½¿ç”¨æˆ‘ä»¬çš„åº”ç”¨
  }

  // ç°åœ¨ä½ å¯ä»¥å¯åŠ¨ä½ çš„åº”ç”¨å¹¶è‡ªç”±è®¿é—® Web3.js:
  startApp()

})
    </script>
  </body>
</html>

```

## ç¬¬3ç« : å’Œåˆçº¦å¯¹è¯

ç°åœ¨ï¼Œæˆ‘ä»¬å·²ç»ç”¨ MetaMask çš„ Web3 æä¾›è€…åˆå§‹åŒ–äº† Web3.jsã€‚æ¥ä¸‹æ¥å°±è®©å®ƒå’Œæˆ‘ä»¬çš„æ™ºèƒ½åˆçº¦å¯¹è¯å§ã€‚

Web3.js éœ€è¦ä¸¤ä¸ªä¸œè¥¿æ¥å’Œä½ çš„åˆçº¦å¯¹è¯: å®ƒçš„ **åœ°å€** å’Œå®ƒçš„ **ABI**ã€‚

### åˆçº¦åœ°å€

åœ¨ä½ å†™å®Œäº†ä½ çš„æ™ºèƒ½åˆçº¦åï¼Œä½ éœ€è¦ç¼–è¯‘å®ƒå¹¶æŠŠå®ƒéƒ¨ç½²åˆ°ä»¥å¤ªåŠã€‚æˆ‘ä»¬å°†åœ¨**ä¸‹ä¸€è¯¾**ä¸­è¯¦è¿°**éƒ¨ç½²**ï¼Œå› ä¸ºå®ƒå’Œå†™ä»£ç æ˜¯æˆªç„¶ä¸åŒçš„è¿‡ç¨‹ï¼Œæ‰€ä»¥æˆ‘ä»¬å†³å®šæ‰“ä¹±é¡ºåºï¼Œå…ˆæ¥è®² Web3.jsã€‚

åœ¨ä½ éƒ¨ç½²æ™ºèƒ½åˆçº¦ä»¥åï¼Œå®ƒå°†è·å¾—ä¸€ä¸ªä»¥å¤ªåŠä¸Šçš„æ°¸ä¹…åœ°å€ã€‚å¦‚æœä½ è¿˜è®°å¾—ç¬¬äºŒè¯¾ï¼ŒCryptoKitties åœ¨ä»¥å¤ªåŠä¸Šçš„åœ°å€æ˜¯ `YOUR_CONTRACT_ADDRESS`ã€‚

ä½ éœ€è¦åœ¨éƒ¨ç½²åå¤åˆ¶è¿™ä¸ªåœ°å€ä»¥æ¥å’Œä½ çš„æ™ºèƒ½åˆçº¦å¯¹è¯ã€‚

### åˆçº¦ ABI

å¦ä¸€ä¸ª Web3.js ä¸ºäº†è¦å’Œä½ çš„æ™ºèƒ½åˆçº¦å¯¹è¯è€Œéœ€è¦çš„ä¸œè¥¿æ˜¯ **ABI**ã€‚

ABI æ„ä¸ºåº”ç”¨äºŒè¿›åˆ¶æ¥å£ï¼ˆApplication Binary Interfaceï¼‰ã€‚ åŸºæœ¬ä¸Šï¼Œå®ƒæ˜¯ä»¥ JSON æ ¼å¼è¡¨ç¤ºåˆçº¦çš„æ–¹æ³•ï¼Œå‘Šè¯‰ Web3.js å¦‚ä½•ä»¥åˆåŒç†è§£çš„æ–¹å¼æ ¼å¼åŒ–å‡½æ•°è°ƒç”¨ã€‚

å½“ä½ ç¼–è¯‘ä½ çš„åˆçº¦å‘ä»¥å¤ªåŠéƒ¨ç½²æ—¶(æˆ‘ä»¬å°†åœ¨ç¬¬ä¸ƒè¯¾è¯¦è¿°)ï¼Œ Solidity ç¼–è¯‘å™¨ä¼šç»™ä½  ABIï¼Œæ‰€ä»¥é™¤äº†åˆçº¦åœ°å€ï¼Œä½ è¿˜éœ€è¦æŠŠè¿™ä¸ªä¹Ÿå¤åˆ¶ä¸‹æ¥ã€‚

å› ä¸ºæˆ‘ä»¬è¿™ä¸€è¯¾ä¸ä¼šè®²è¿°éƒ¨ç½²ï¼Œæ‰€ä»¥ç°åœ¨æˆ‘ä»¬å·²ç»å¸®ä½ ç¼–è¯‘äº† ABI å¹¶æ”¾åœ¨äº†åä¸º`cryptozombies_abi.js`ï¼Œæ–‡ä»¶ä¸­ï¼Œä¿å­˜åœ¨ä¸€ä¸ªåä¸º `cryptozombiesABI` çš„å˜é‡ä¸­ã€‚

å¦‚æœæˆ‘ä»¬å°†`cryptozombies_abi.js` åŒ…å«è¿›æˆ‘ä»¬çš„é¡¹ç›®ï¼Œæˆ‘ä»¬å°±èƒ½é€šè¿‡é‚£ä¸ªå˜é‡è®¿é—® CryptoZombies ABI ã€‚

### å®ä¾‹åŒ– Web3.js

ä¸€æ—¦ä½ æœ‰äº†åˆçº¦çš„åœ°å€å’Œ ABIï¼Œä½ å¯ä»¥åƒè¿™æ ·æ¥å®ä¾‹åŒ– Web3.jsã€‚

```
// å®ä¾‹åŒ– myContract
var myContract = new web3js.eth.Contract(myABI, myContractAddress);
```

### å®æˆ˜æ¼”ä¹ 

1. åœ¨æ–‡ä»¶çš„ `<head>` æ ‡ç­¾å—ä¸­ï¼Œç”¨ `script` æ ‡ç­¾å¼•å…¥`cryptozombies_abi.js`ï¼Œå¥½æŠŠ ABI çš„å®šä¹‰å¼•å…¥é¡¹ç›®ã€‚
2. åœ¨ `<body>` é‡Œçš„ `<script>` å¼€å¤´ , å®šä¹‰ä¸€ä¸ª`var`ï¼Œå–å `cryptoZombies`ï¼Œ ä¸è¿‡ä¸è¦å¯¹å…¶èµ‹å€¼ï¼Œç¨åæˆ‘ä»¬å°†ç”¨è¿™ä¸ªè¿™ä¸ªå˜é‡æ¥å­˜å‚¨æˆ‘ä»¬å®ä¾‹åŒ–åˆçº¦ã€‚
3. æ¥ä¸‹æ¥ï¼Œåˆ›å»ºä¸€ä¸ªåä¸º `startApp()` çš„ `function`ã€‚ æ¥ä¸‹æ¥ä¸¤æ­¥æ¥å®Œæˆè¿™ä¸ªæ–¹æ³•ã€‚
4. `startApp()` é‡Œåº”è¯¥åšçš„ç¬¬ä¸€ä»¶äº‹æ˜¯å®šä¹‰ä¸€ä¸ªåä¸º`cryptoZombiesAddress` çš„å˜é‡å¹¶èµ‹å€¼ä¸º`"ä½ çš„åˆçº¦åœ°å€"` (è¿™æ˜¯ä½ çš„åˆçº¦åœ¨ä»¥å¤ªåŠä¸»ç½‘ä¸Šçš„åœ°å€)ã€‚
5. æœ€åï¼Œæ¥å®ä¾‹åŒ–æˆ‘ä»¬çš„åˆçº¦ã€‚æ¨¡ä»¿æˆ‘ä»¬ä¸Šé¢çš„ä»£ç ï¼Œå°† `cryptoZombies` èµ‹å€¼ä¸º `new` `web3js.eth.Contract` (ä½¿ç”¨æˆ‘ä»¬ä¸Šé¢ä»£ç ä¸­é€šè¿‡ `script` å¼•å…¥çš„ `cryptoZombiesABI` å’Œ `cryptoZombiesAddress`)ã€‚

```
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>CryptoZombies front-end</title>
    <script language="javascript" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script language="javascript" type="text/javascript" src="web3.min.js"></script>
    <!-- 1. Include cryptozombies_abi.js here -->
    <script language="javascript" type="text/javascript" src="cryptozombies_abi.js"></script>
  </head>
  <body>

    <script>
      // 2. Start code here
      var cryptoZombies;

      function startApp() {
        var cryptoZombiesAddress = "ä½ çš„åˆçº¦åœ°å€";
        cryptoZombies = new web3js.eth.Contract(cryptoZombiesABI, cryptoZombiesAddress);
      }

      window.addEventListener('load', function() {

        // Checking if Web3 has been injected by the browser (Mist/MetaMask)
        if (typeof web3 !== 'undefined') {
          // Use Mist/MetaMask's provider
          web3js = new Web3(web3.currentProvider);
        } else {
          // Handle the case where the user doesn't have Metamask installed
          // Probably show them a message prompting them to install Metamask
        }

        // Now you can start your app & access web3 freely:
        startApp()

      })
    </script>
  </body>
</html>
```

# ç¬¬4ç« : è°ƒç”¨å’Œåˆçº¦å‡½æ•°

æˆ‘ä»¬çš„åˆçº¦é…ç½®å¥½äº†ï¼ç°åœ¨æ¥ç”¨ Web3.js å’Œå®ƒå¯¹è¯ã€‚

Web3.js æœ‰ä¸¤ä¸ªæ–¹æ³•æ¥è°ƒç”¨æˆ‘ä»¬åˆçº¦çš„å‡½æ•°: `call` and `send`.

### Call

`call` ç”¨æ¥è°ƒç”¨ `view` å’Œ `pure` å‡½æ•°ã€‚å®ƒåªè¿è¡Œåœ¨æœ¬åœ°èŠ‚ç‚¹ï¼Œä¸ä¼šåœ¨åŒºå—é“¾ä¸Šåˆ›å»ºäº‹åŠ¡ã€‚

> **å¤ä¹ :** `view` å’Œ `pure` å‡½æ•°æ˜¯åªè¯»çš„å¹¶ä¸ä¼šæ”¹å˜åŒºå—é“¾çš„çŠ¶æ€ã€‚å®ƒä»¬ä¹Ÿä¸ä¼šæ¶ˆè€—ä»»ä½•gasã€‚ç”¨æˆ·ä¹Ÿä¸ä¼šè¢«è¦æ±‚ç”¨MetaMaskå¯¹äº‹åŠ¡ç­¾åã€‚

ä½¿ç”¨ Web3.jsï¼Œä½ å¯ä»¥å¦‚ä¸‹ `call` ä¸€ä¸ªåä¸º`myMethod`çš„æ–¹æ³•å¹¶ä¼ å…¥ä¸€ä¸ª `123` ä½œä¸ºå‚æ•°ï¼š

```
myContract.methods.myMethod(123).call()
```

### Send

`send` å°†åˆ›å»ºä¸€ä¸ªäº‹åŠ¡å¹¶æ”¹å˜åŒºå—é“¾ä¸Šçš„æ•°æ®ã€‚ä½ éœ€è¦ç”¨ `send` æ¥è°ƒç”¨ä»»ä½•é `view`æˆ–è€… `pure` çš„å‡½æ•°ã€‚

> **æ³¨æ„:** `send` ä¸€ä¸ªäº‹åŠ¡å°†è¦æ±‚ç”¨æˆ·æ”¯ä»˜gasï¼Œå¹¶ä¼šè¦æ±‚å¼¹å‡ºå¯¹è¯æ¡†è¯·æ±‚ç”¨æˆ·ä½¿ç”¨ Metamask å¯¹äº‹åŠ¡ç­¾åã€‚åœ¨æˆ‘ä»¬ä½¿ç”¨ Metamask ä½œä¸ºæˆ‘ä»¬çš„ web3 æä¾›è€…çš„æ—¶å€™ï¼Œæ‰€æœ‰è¿™ä¸€åˆ‡éƒ½ä¼šåœ¨æˆ‘ä»¬è°ƒç”¨ `send()` çš„æ—¶å€™è‡ªåŠ¨å‘ç”Ÿã€‚è€Œæˆ‘ä»¬è‡ªå·±æ— éœ€åœ¨ä»£ç ä¸­æ“å¿ƒè¿™ä¸€åˆ‡ï¼ŒæŒºçˆ½çš„å§ã€‚

ä½¿ç”¨ Web3.js, ä½ å¯ä»¥åƒè¿™æ · `send` ä¸€ä¸ªäº‹åŠ¡è°ƒç”¨`myMethod` å¹¶ä¼ å…¥ `123` ä½œä¸ºå‚æ•°ï¼š

```
myContract.methods.myMethod(123).send()
```

è¯­æ³•å‡ ä¹ `call()`ä¸€æ¨¡ä¸€æ ·ã€‚

## è·å–åƒµå°¸æ•°æ®

æ¥çœ‹ä¸€ä¸ªä½¿ç”¨ `call` è¯»å–æˆ‘ä»¬åˆçº¦æ•°æ®çš„çœŸå®ä¾‹å­

å›å¿†ä¸€ä¸‹ï¼Œæˆ‘ä»¬å®šä¹‰æˆ‘ä»¬çš„åƒµå°¸æ•°ç»„ä¸º `å…¬å¼€`(public):

```
Zombie[] public zombies;
```

åœ¨ Solidity é‡Œï¼Œå½“ä½ å®šä¹‰ä¸€ä¸ª `public`å˜é‡çš„æ—¶å€™ï¼Œ å®ƒå°†è‡ªåŠ¨å®šä¹‰ä¸€ä¸ªå…¬å¼€çš„ "getter" åŒåæ–¹æ³•ï¼Œ æ‰€ä»¥å¦‚æœä½ åƒè¦æŸ¥çœ‹ id ä¸º `15` çš„åƒµå°¸ï¼Œä½ å¯ä»¥åƒä¸€ä¸ªå‡½æ•°ä¸€æ ·è°ƒç”¨å®ƒï¼š `zombies(15)`.

è¿™æ˜¯å¦‚ä½•åœ¨å¤–é¢çš„å‰ç«¯ç•Œé¢ä¸­å†™ä¸€ä¸ª JavaScript æ–¹æ³•æ¥ä¼ å…¥ä¸€ä¸ªåƒµå°¸ idï¼Œåœ¨æˆ‘ä»¬çš„åˆåŒä¸­æŸ¥è¯¢é‚£ä¸ªåƒµå°¸å¹¶è¿”å›ç»“æœ

> æ³¨æ„: æœ¬è¯¾ä¸­æ‰€æœ‰çš„ç¤ºä¾‹ä»£ç éƒ½ä½¿ç”¨ Web3.js çš„ **1.0 ç‰ˆ**ï¼Œæ­¤ç‰ˆæœ¬ä½¿ç”¨çš„æ˜¯ Promises è€Œä¸æ˜¯å›è°ƒå‡½æ•°ã€‚ä½ åœ¨çº¿ä¸Šçœ‹åˆ°çš„å…¶ä»–æ•™ç¨‹å¯èƒ½è¿˜åœ¨ä½¿ç”¨è€ç‰ˆçš„ Web3.jsã€‚åœ¨1.0ç‰ˆä¸­ï¼Œè¯­æ³•æ”¹å˜äº†ä¸å°‘ã€‚å¦‚æœä½ ä»å…¶ä»–æ•™ç¨‹ä¸­å¤åˆ¶ä»£ç ï¼Œå…ˆç¡®ä¿ä½ ä»¬ä½¿ç”¨çš„æ˜¯ç›¸åŒç‰ˆæœ¬çš„Web3.jsã€‚

```
function getZombieDetails(id) {
  return cryptoZombies.methods.zombies(id).call()
}

// è°ƒç”¨å‡½æ•°å¹¶åšä¸€äº›å…¶ä»–äº‹æƒ…
getZombieDetails(15)
.then(function(result) {
  console.log("Zombie 15: " + JSON.stringify(result));
});
```

æˆ‘ä»¬æ¥çœ‹çœ‹è¿™é‡Œéƒ½åšäº†ä»€ä¹ˆ

`cryptoZombies.methods.zombies(id).call()` å°†å’Œ Web3 æä¾›è€…èŠ‚ç‚¹é€šä¿¡ï¼Œå‘Šè¯‰å®ƒè¿”å›ä»æˆ‘ä»¬çš„åˆçº¦ä¸­çš„ `Zombie[] public zombies`ï¼Œ`id`ä¸ºä¼ å…¥å‚æ•°çš„åƒµå°¸ä¿¡æ¯ã€‚

æ³¨æ„è¿™æ˜¯ **å¼‚æ­¥çš„**ï¼Œå°±åƒä»å¤–éƒ¨æœåŠ¡å™¨ä¸­è°ƒç”¨APIã€‚æ‰€ä»¥ Web3 åœ¨è¿™é‡Œè¿”å›äº†ä¸€ä¸ª Promises. (å¦‚æœä½ å¯¹ JavaScriptçš„ Promises ä¸äº†è§£ï¼Œæœ€å¥½å…ˆå»å­¦ä¹ ä¸€ä¸‹è¿™æ–¹é¢çŸ¥è¯†å†ç»§ç»­)ã€‚

ä¸€æ—¦é‚£ä¸ª `promise` è¢« `resolve`, (æ„å‘³ç€æˆ‘ä»¬ä» Web3 æä¾›è€…é‚£é‡Œè·å¾—äº†å“åº”)ï¼Œæˆ‘ä»¬çš„ä¾‹å­ä»£ç å°†æ‰§è¡Œ `then` è¯­å¥ä¸­çš„ä»£ç ï¼Œåœ¨æ§åˆ¶å°æ‰“å‡º `result`ã€‚

`result` æ˜¯ä¸€ä¸ªåƒè¿™æ ·çš„ JavaScript å¯¹è±¡ï¼š

```
{
  "name": "H4XF13LD MORRIS'S COOLER OLDER BROTHER",
  "dna": "1337133713371337",
  "level": "9999",
  "readyTime": "1522498671",
  "winCount": "999999999",
  "lossCount": "0" // Obviously.
}
```

æˆ‘ä»¬å¯ä»¥ç”¨ä¸€äº›å‰ç«¯é€»è¾‘ä»£ç æ¥è§£æè¿™ä¸ªå¯¹è±¡å¹¶åœ¨å‰ç«¯ç•Œé¢å‹å¥½å±•ç¤ºã€‚

## å®æˆ˜æ¼”ä¹ 

æˆ‘ä»¬å·²ç»å¸®ä½ æŠŠ `getZombieDetails` å¤åˆ¶è¿›äº†ä»£ç ã€‚

1. å…ˆä¸º`zombieToOwner` åˆ›å»ºä¸€ä¸ªç±»ä¼¼çš„å‡½æ•°ã€‚å¦‚æœä½ è¿˜è®°å¾— `ZombieFactory.sol`ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªé•¿è¿™æ ·çš„æ˜ å°„ï¼š

   ```
   mapping (uint => address) public zombieToOwner;
   ```

   å®šä¹‰ä¸€ä¸ª JavaScript æ–¹æ³•ï¼Œèµ·åä¸º `zombieToOwner`ã€‚å’Œä¸Šé¢çš„ `getZombieDetails` ç±»ä¼¼ï¼Œ å®ƒå°†æ¥æ”¶ä¸€ä¸ª`id` ä½œä¸ºå‚æ•°ï¼Œå¹¶è¿”å›ä¸€ä¸ª Web3.js `call` æˆ‘ä»¬åˆçº¦é‡Œçš„`zombieToOwner` ã€‚

2. ä¹‹ååœ¨ä¸‹é¢ï¼Œä¸º `getZombiesByOwner` å®šä¹‰ä¸€ä¸ªæ–¹æ³•ã€‚å¦‚æœä½ è¿˜èƒ½è®°èµ· `ZombieHelper.sol`ï¼Œè¿™ä¸ªæ–¹æ³•å®šä¹‰åƒè¿™æ ·ï¼š

   ```
   function getZombiesByOwner(address _owner)
   ```

   æˆ‘ä»¬çš„ `getZombiesByOwner` æ–¹æ³•å°†æ¥æ”¶ `owner` ä½œä¸ºå‚æ•°ï¼Œå¹¶è¿”å›ä¸€ä¸ªå¯¹æˆ‘ä»¬å‡½æ•° `getZombiesByOwner`çš„ Web3.js `call`

   ```
   <!DOCTYPE html>
   <html lang="en">
     <head>
       <meta charset="UTF-8">
       <title>CryptoZombies front-end</title>
       <script language="javascript" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
       <script language="javascript" type="text/javascript" src="web3.min.js"></script>
       <script language="javascript" type="text/javascript" src="cryptozombies_abi.js"></script>
     </head>
     <body>
   
       <script>
         var cryptoZombies;
   
         function startApp() {
           var cryptoZombiesAddress = "YOUR_CONTRACT_ADDRESS";
           cryptoZombies = new web3js.eth.Contract(cryptoZombiesABI, cryptoZombiesAddress);
         }
   
         function getZombieDetails(id) {
           return cryptoZombies.methods.zombies(id).call();
         }
   
         // 1. Define `zombieToOwner` here
         function zombieToOwner(id) {
           return cryptoZombies.methods.zombieToOwner(id).call();
         }
   
         // 2. Define `getZombiesByOwner` here
         function getZombiesByOwner(owner) {
           return cryptoZombies.methods.getZombiesByOwner(owner).call();
         }
   
         window.addEventListener('load', function() {
   
           // Checking if Web3 has been injected by the browser (Mist/MetaMask)
           if (typeof web3 !== 'undefined') {
             // Use Mist/MetaMask's provider
             web3js = new Web3(web3.currentProvider);
           } else {
             // Handle the case where the user doesn't have Metamask installed
             // Probably show them a message prompting them to install Metamask
           }
   
           // Now you can start your app & access web3 freely:
           startApp()
   
         })
       </script>
     </body>
   </html>
   
    
   
   ```

   